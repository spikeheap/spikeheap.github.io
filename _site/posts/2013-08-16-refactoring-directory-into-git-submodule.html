<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
        <style>
            body {
                padding-top: 50px;
                padding-bottom: 20px;
            }
        </style>
        <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Project name</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <form class="navbar-form navbar-right" role="form">
            <div class="form-group">
              <input type="text" placeholder="Email" class="form-control">
            </div>
            <div class="form-group">
              <input type="password" placeholder="Password" class="form-control">
            </div>
            <button type="submit" class="btn btn-success">Sign in</button>
          </form>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Refactoring a directory into a git submodule</h1>
        <small>16 Aug 2013</small>
        <p></p>
      </div>
    </div>

    <div class="container">
      <!-- Example row of columns -->
      <div class="row">
        <div class="col-xs-12">
          <p>To release the Rsnapshot Puppet module I needed to extract the module directory from our entire Puppet configuration Git repository (we know it’s wrong, but it’s how we started and are moving away from it slowly). Fortunately Git has some great functionality (hint: it’s submodules) to allow the directory to be pulled out into a new repository, keeping the commit history. </p>

<p>The steps I wanted to achieve were:</p>

<ol>
  <li>Create a new repository containing only the Rsnapshot directory (and the commit history for that directory).</li>
  <li>Remove the directory from the Puppet repository and replace it with a pointer to the Rsnapshot repository.</li>
</ol>

<p><a href="http://git-scm.com/book/en/Git-Tools-Submodules">Git submodules</a> solve this use-case. A submodule is treated as a separate repository, but resides within the parent repository’s directory structure. </p>

<!-- more -->

<p>The simplest way to filter the repository is to clone it, apply the filter to the clone and then push the the filtered repository to your origin server (if you use one). The following example assumes you’ve created an empty repository ready for the submodule:</p>

<pre><code class="language-bash">git clone $REPO_URL $SUBMODULE_NAME
cd $SUBMODULE_NAME
git filter-branch --subdirectory-filter '$PATH_TO_SUBMODULE' --prune-empty -- --all

# Clean the repository
git clean -xd -f

# Update the remote (replace "origin" with your remote name)
git remote rm origin
git remote add origin $SUBMODULE_REPO_URL

# Push the new submodule
git push origin master
</code></pre>

<p>All that’s left to do then is remove the existing directory and add the submodule. Even if you’re paranoid the removed directory’s history is still in Git, so it’s easy to roll back.</p>

<pre><code class="language-bash">git rm $PATH_TO_SUBMODULE
git commit -m "Removing directory to replace with submodule" $PATH_TO_SUBMODULE
git submodule add $SUBMODULE_REPO_URL $PATH_TO_SUBMODULE
git add .gitmodules $PATH_TO_SUBMODULE
git commit -m "Adding submodule X"
git push
</code></pre>

<p>For the Puppet example the repository resides at /etc/puppet and I used the following variables:</p>

<pre><code class="language-bash">SUBMODULE_NAME = puppet-rsnapshot
PATH_TO_SUBMODULE = modules/rsnapshot
</code></pre>

<h1 id="references">References</h1>

<ol>
  <li>http://git-scm.com/book/en/Git-Tools-Submodules</li>
  <li>http://stackoverflow.com/questions/12514197/convert-a-git-folder-to-a-submodule-retrospectively</li>
</ol>

        </div>
      </div>

      <hr>

      <footer>
        <p>&copy; Company 2014</p>
      </footer>
    </div> <!-- /container -->  
        <script src="/bower_components/jquery/dist/jquery.min.js"></script>
        <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-XXXXX-X');ga('send','pageview');
        </script>
    </body>
</html>

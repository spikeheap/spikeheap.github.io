<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
        <style>
            body {
                padding-top: 50px;
                padding-bottom: 20px;
            }
        </style>
        <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Project name</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <form class="navbar-form navbar-right" role="form">
            <div class="form-group">
              <input type="text" placeholder="Email" class="form-control">
            </div>
            <div class="form-group">
              <input type="password" placeholder="Password" class="form-control">
            </div>
            <button type="submit" class="btn btn-success">Sign in</button>
          </form>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Setting up Grails code quality tools with local Sonar</h1>
        <small>21 Nov 2013</small>
        <p></p>
      </div>
    </div>

    <div class="container">
      <!-- Example row of columns -->
      <div class="row">
        <div class="col-xs-12">
          <p>We want to be able to measure code quality for a Grails/Javascript project I’ve just joined. I have had good experiences with Sonar before, so set out to get the important (to me) metrics from one into the other:</p>

<ul>
  <li>Code coverage</li>
  <li>Complexity</li>
  <li>Duplicated code</li>
  <li>Code violations (poor coding constructs)</li>
</ul>

<p>Despite a load of Google results suggesting it would be impossible (or at least quite hard), it turned out to be relatively straightforward.</p>

<!-- more -->

<h2 id="setting-up-sonar">Setting up Sonar</h2>

<p>Install sonar using brew:<br />
<code>bash
brew install sonar sonar-runner
</code></p>

<p>To have launchd start sonar at login:<br />
<code>bash
ln -sfv /opt/boxen/homebrew/opt/sonar/*.plist ~/Library/LaunchAgents
</code></p>

<p>Then to load sonar now:<br />
<code>bash
launchctl load ~/Library/LaunchAgents/homebrew.mxcl.sonar.plist
</code></p>

<p>You can check it’s running at http://localhost:9000/, but you can use nginx to give you a prettier URL (I’ll cover that in a later post). While you’re at it <strong>change the default “admin” user password from “admin”</strong>.</p>

<h2 id="adding-maven-to-the-grails-project-to-run-sonar">Adding Maven to the Grails project to run Sonar</h2>

<p>We need to set up Maven to post the results to Sonar. Because we don’t want local machine configuration included in the project Git repository, let’s add the database connection details to our local Maven settings file (~/.m2/settings.xml) which may not exist yet, so just create it with the following contents:</p>

<gist>spikeheap/7563286</gist>

<p>The important elements to check are:</p>

<ul>
  <li>sonar.host.url, which should be “http://localhost:9000” unless you’re proxying through nginx</li>
  <li>sonar.jdbc.url and ensure that database actually exists (I use postgres, pick your own flavour)</li>
  <li>sonar.jdbc.username</li>
  <li>sonar.jdbc.password</li>
</ul>

<p>You then need to add a pom.xml file to the project you want to analyse:</p>

<gist>spikeheap/7564644</gist>

<p>Here the points of interest are:</p>

<ul>
  <li>groupId</li>
  <li>artifactId</li>
  <li>name</li>
  <li>sources, ensuring all your source code is under inspection</li>
</ul>

<p>You can test for success by running “mvn sonar:sonar -DskipTests=true” in the same directory as the pom.xml file. All things being equal it will show “Build Success” on the command line and populate your Sonar installation with a project.</p>

<p>Note that this only does analysis of the Groovy files, and analyses the Java source using the Groovy rules. Newer versions of Sonar support multi-language projects, but in a fairly awkward way. Perhaps over the weekend I’ll get a chance to include some Javascript code quality too.</p>

<p>When I next get a few minutes I’m going to get this set up in Jenkins and tie it all together with nginx, and possibly write about how we’re automating it all with Boxen. Until the next time…</p>


        </div>
      </div>

      <hr>

      <footer>
        <p>&copy; Company 2014</p>
      </footer>
    </div> <!-- /container -->  
        <script src="/bower_components/jquery/dist/jquery.min.js"></script>
        <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-XXXXX-X');ga('send','pageview');
        </script>
    </body>
</html>

<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
        <style>
            body {
                padding-top: 50px;
                padding-bottom: 20px;
            }
        </style>
        <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Project name</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <form class="navbar-form navbar-right" role="form">
            <div class="form-group">
              <input type="text" placeholder="Email" class="form-control">
            </div>
            <div class="form-group">
              <input type="password" placeholder="Password" class="form-control">
            </div>
            <button type="submit" class="btn btn-success">Sign in</button>
          </form>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Preparing a Git repository for open-sourcification</h1>
        <small>16 Dec 2013</small>
        <p></p>
      </div>
    </div>

    <div class="container">
      <!-- Example row of columns -->
      <div class="row">
        <div class="col-xs-12">
          <p>A project I’m involved with is going through the process of being open-sourced and released on GitHub. This is a great development, but of course we have had to go through and make sure that we’re able to release everything. The project started out life in a single Git repository so there’s plenty of bootstrap data that’s owned by other groups within the University. Fortunately there’s an easy way in Git to go through your history and remove the offending articles. </p>

<!-- more -->

<p><strong>Update 18/12/2013</strong> For those who don’t want to re-clone their project, I’ve added the commands to flush the deleted refs from your local repository. I’ve also added a small section on identifying and removing space-hungry sections of the git repository.</p>

<p>There are many ways to achieve the same goal, and we could arguably have retained the same repository, however it’s a nice opportunity to clear out the 300Mb which magically worked its way into the repository at some point and generally streamline our code.</p>

<h5 id="a-word-of-warning">A word of warning</h5>
<p>The following will go through your entire tree and remove all references to the files you’re removing, rewriting commits where necessary. As a result your local repository will likely wildly differ from the remote repository, so you’ll need to coordinate this with your fellow team members. If your repository is already in the wild is there much point in causing this much pain? You can probably just get away with removing it from your tags and branches, which is far less invasive.</p>

<h5 id="a-second-word-of-warning">A second word of warning</h5>
<p>This is a destructive process that rewrites history. <strong>Make sure you’ve got a backup</strong> before attempting this, just in case things go pear-shaped.</p>

<p><strong>Update 18/12/2013</strong> GitHub’s documentation is pretty thorough, so it wasn’t surprising to find <a href="https://help.github.com/articles/remove-sensitive-data">a page on removing sensitive data</a>. I’ve updated this post to reflect some of the suggestions in that page.</p>

<p>The first thing to do is remove the offending content from your repository, and push that change. This is an important step because you want a commit at HEAD which isn’t modified by the following actions, which allows other users to pull the changes without having to nuke their repository.</p>

<pre><code class="language-bash">git rm  path/to/our/secret/bootstrap-data/
git commit -m "Removing bootstrap data" path/to/our/secret/bootstrap-data/
git push
</code></pre>

<p>Then we can filter the commit history to remove the offending content from the history of all branches:</p>

<pre><code class="language-bash">git filter-branch --force --index-filter 'git rm --cached --ignore-unmatch path/to/our/secret/bootstrap-data/' --prune-empty --tag-name-filter cat -- --all
</code></pre>

<p>Because you’ve just rewritten history, the <code>git status</code> command will then yield something like</p>

<pre><code># On branch develop
# Your branch and 'origin/develop' have diverged,
# and have 373 and 372 different commits each, respectively.
#   (use "git pull" to merge the remote branch into yours)
#
nothing to commit, working directory clean
</code></pre>

<p>The next thing to do is purge it from the local repository by forcing a garbage collection, like so:</p>

<pre><code class="language-bash">rm -rf .git/refs/original/
git reflog expire --expire=now --all
git gc --prune=now
git gc --aggressive --prune=now
</code></pre>

<h2 id="clearing-large-repositories">Clearing large repositories</h2>
<p>In our case, our project was around ~15Mb, however the repository had racked up over 300Mb. The obvious culprit is committed <code>target</code> directories, libraries and built WAR files.</p>

<p>To find out the size of your git repository, use <code>git count-objects -v</code> (you’re looking for the size-pack value, which is the project size in kilobytes). </p>

<p>Ted Naleid has written an excellent article on <a href="http://naleid.com/blog/2012/01/17/finding-and-purging-big-files-from-git-history">finding and purging big files from git history</a>, along with a couple of one-liners to get locate the biggest files. </p>

<p>I’ve dumped the above into a handy little script:</p>

<gist>spikeheap/8019649</gist>

<!-- TODO Overwriting history, or pushing a new repository -->

<h2 id="reapplying-commits">Reapplying commits</h2>
<p>It’s almost certainly the case that someone cloned your repository and made some changes while you were off rewriting history. If you’re now working on a new repository, the easiest way might be to create a patch from the old repo and then apply it to the new one. Using the following command, “-1” refers to the last 1 commit, so you can use “-2”, “-3”, and so on.</p>

<pre><code class="language-bash"># Make a patchfile 
git format-patch -1

# Apply the patchfile
patch -p1 &lt; file.patch
</code></pre>

<p>And voila, you’re back up and running again. Of course there’s plenty more to do: adding a permissive license, attributing any libraries and most importantly building a pretty website for it…</p>

        </div>
      </div>

      <hr>

      <footer>
        <p>&copy; Company 2014</p>
      </footer>
    </div> <!-- /container -->  
        <script src="/bower_components/jquery/dist/jquery.min.js"></script>
        <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-XXXXX-X');ga('send','pageview');
        </script>
    </body>
</html>

<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
        <style>
            body {
                padding-top: 50px;
                padding-bottom: 20px;
            }
        </style>
        <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Project name</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <form class="navbar-form navbar-right" role="form">
            <div class="form-group">
              <input type="text" placeholder="Email" class="form-control">
            </div>
            <div class="form-group">
              <input type="password" placeholder="Password" class="form-control">
            </div>
            <button type="submit" class="btn btn-success">Sign in</button>
          </form>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Managing sudoers with Puppet</h1>
        <small>13 Aug 2013</small>
        <p></p>
      </div>
    </div>

    <div class="container">
      <!-- Example row of columns -->
      <div class="row">
        <div class="col-xs-12">
          <blockquote>
Managing the sudoers file of the puppetmaster with Puppet is like playing with fire while drenched in petrol. If you must do it be really *really* careful!
</blockquote>

<p>Today I re-learned a valuable lesson about the power of Puppet: it can be a force for evil if you forget the little extra things you set up weeks ago. Fortunately it’s easy to reproduce, so try it for yourself! If there’s ever an obvious reason to keep a remote clone of your Puppet configuration, this is it.</p>

<!--more-->

<p>Step one is easy. To have a good self-managing Puppet setup you really want your clients to auto-configure themselves. That configuration is going to do sane things like (for example) setting ‘pluginsync’ and ensuring the Puppet client daemon is running, configured to start on boot, etc. </p>

<p>Step two follows a little while later. The need arises to manage a sudoers file and rather than reinvent the wheel you install the popular <a href="https://forge.puppetlabs.com/saz/sudo"><em>sudo</em> package by <em>saz</em></a>.</p>

<p>This package got a <a href="https://puppetlabs.com/blog/module-of-the-week-sazsudo-manage-sudo-configuration/">great review from PuppetLabs</a> and is easy to configure:</p>

<pre><code class="language-ruby"># Manage sudoers with the module
class { 'sudo': }

# Declare a sudoer with the username 'bill'
sudo::conf { 'bill':
  priority =&gt; 10,
  content  =&gt; 'bill ALL=(ALL) NOPASSWD: ALL',
}
</code></pre>

<p>The key step here is to run Puppet and see new files created in /etc/sudoers.d/, check the content and think all is well. The <em>facepalm</em> moment really happened when I failed to check the run had added the <em>include</em> into the sudoers file to make it bother to read the files in <em>sudoers.d</em>. Unfortunately for me this hadn’t happened, so although the files were there I no longer had sudo privileges on the client.</p>

<p>No problem! Simply fixing the module to add the <em>include</em> statement would bring the client back online. Unless step three has been done.</p>

<p>Step three closes the loop on this suprisingly vicious circle. A few days prior to step two I was refactoring <em>site.pp</em> and decide to move the puppetmaster into the default node group so I could define it using Hiera. The migration was simple (thanks Hiera!) but in my common definition I had included the puppet client package, which caused the puppetmaster to start updating every 30 minutes like every other node.</p>

<p>I was a couple of minutes too late to prevent the disaster. Locking myself out of the puppetmaster was a little embarrassing, but did give me the opportunity to build the puppetmaster from scratch using Puppet. Oh how a technology can redeem itself.</p>

<h5 id="rebuilding-the-puppetmaster-from-scratch">Rebuilding the puppetmaster from scratch</h5>

<p>Building the puppetmaster from only the /etc/puppet configuration is actually suprisingly easy. After pushing a change to the puppet repository which would prevent the problem above from being deployed to the new instance, the full steps to provision a new VM and go from zero to a full installation were:</p>

<ul>
  <li>Provision the VM and log into it.</li>
  <li><a href="http://apt.puppetlabs.com/README.txt">Add the newest Puppet repositories to APT</a> (my Puppet configuration would do this later, but lets start as we mean to go on).</li>
  <li>Run the usual <code>apt-get install puppet git</code></li>
  <li>Clone the Git repository of the Puppet configuration (the entirety of /etc/puppet).</li>
  <li>Use <em>puppet apply</em> on <em>site.pp</em>. I expected this to fail (and it did raise a couple of errors) but it did a significant enough job to then allow puppetmaster to start and a <em>puppet agent -t</em> to be run. <code>bash puppet apply /etc/puppet/manifests/site.pp </code></li>
  <li>Make a cup of tea and bask in the reflected glory. </li>
</ul>

<h5 id="lessons-learned">Lessons learned</h5>

<p>So the lessons to be learned from this exercise are many and obvious:</p>

<ol>
  <li>Always keep a remote clone (or backup) of your Puppet configuration.</li>
  <li>Check the puppetmaster’s configuration doubly-trebly carefully, especially for the crux items like sudo where you could be locked out.</li>
  <li>A fully managed Puppet node is trivial to bring up, even if that node is the puppetmaster.</li>
</ol>

<p>Although I would rather not have been through an hour of pain learning this lesson, I now have a much stronger confidence in our configuration’s resilience, so there’s always a silver lining.</p>

<p>Now, break over, back to the Puppet Rsnapshot module…</p>

        </div>
      </div>

      <hr>

      <footer>
        <p>&copy; Company 2014</p>
      </footer>
    </div> <!-- /container -->  
        <script src="/bower_components/jquery/dist/jquery.min.js"></script>
        <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-XXXXX-X');ga('send','pageview');
        </script>
    </body>
</html>

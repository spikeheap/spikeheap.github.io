<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
        <style>
            body {
                padding-top: 50px;
                padding-bottom: 20px;
            }
        </style>
        <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Project name</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <form class="navbar-form navbar-right" role="form">
            <div class="form-group">
              <input type="text" placeholder="Email" class="form-control">
            </div>
            <div class="form-group">
              <input type="password" placeholder="Password" class="form-control">
            </div>
            <button type="submit" class="btn btn-success">Sign in</button>
          </form>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Cleaning up if-else regex matches in Perl with given-when</h1>
        <small>05 Apr 2012</small>
        <p></p>
      </div>
    </div>

    <div class="container">
      <!-- Example row of columns -->
      <div class="row">
        <div class="col-xs-12">
          <p>One of our applications written in Perl parses large text files to collect information about it. We’ve ended up applying it (over time) to various different areas, and we’re now in a position where we create new versions regularly.</p>

<p>As we started re-using what was then a simple script, we took the obvious step to abstract the common code into a central library. Now we’re not re-using code, the individual ‘parser’ scripts are effectively just if-else blocks matching the different lines:</p>

<pre><code class="language-perl">use strict;
use warnings;

# For each line in the file
my $line = $_;

if(my ($name, $age) = $line =~ /My name is ([A-Za-z]+) and I am (\d+) years old/){
	$personbuilder-&gt;addPerson($name, $age);
}elsif($line =~ /I like Perl/){
	$personbuilder-&gt;addPreference("Perl");
}
# ... imagine a whole load more elsif statements here 
else{
	$logger-&gt;error("Line not matched: "+$line);
	die;
}
</code></pre>

<p>The above is a contrived example, but line 3 demonstrates the problem of collecting multiple groups from the regular expression match. As the number of groups increases the whole line becomes a bit unreadable. The main problem is it’s really easy to add an <em>if</em> rather than an <em>elsif</em> and your whole script breaks down.</p>

<p>So while I was doing some routine maintenance of a script the other day I found the Perl <strong>given/when</strong> construct. It doesn’t have the advantage of being immediately recognisable to anyone who’s ever programmed, but is fairly intuitive:</p>

<pre><code class="language-perl">use strict;
use warnings;
use v5.10;

for(my $i = 0; $i &amp;lt; 10; $i++){
	my $line = "This contains $i winnings for ";
	$line .= "the ${i}th winnner.";
	
	if($i % 3 == 0){
		$line = "no dice";
	}	
	
	given($line){
		when(/This contains (\d+) winnings for (.*)/){
			my $winnings = $1;
			my $winner = $2;
			print "Amount: ".$winnings ."\n";
			print "Winner: " .$winner . ".\n";
		}
		when(/no dice/){
			print "\t". $_ . "\n";
		}
		default { 
			print "NOT MATCHED\n";
		} 
	}
}
</code></pre>

<p>The above code provides a nice safeguard in that a <em>when</em> can only mean one thing, and can’t be swapped out for an <em>if</em>. Breaking it down into multiple <em>given</em> blocks is more obvious and requires more effort, so it’s harder to introduce and easier to fix bugs.</p>

<p>The <em>when</em> statement uses Perl’s smart matching feature, so you can use Strings, numbers, regular expressions or booleans, with some caveats about how clever it is. Read more here: <a href="http://perldoc.perl.org/perlsyn.html">http://perldoc.perl.org/perlsyn.html</a> and here: <a href="http://szabgab.com/smart-matching-in-perl-5.10.html">http://szabgab.com/smart-matching-in-perl-5.10.html</a></p>

        </div>
      </div>

      <hr>

      <footer>
        <p>&copy; Company 2014</p>
      </footer>
    </div> <!-- /container -->  
        <script src="/bower_components/jquery/dist/jquery.min.js"></script>
        <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-XXXXX-X');ga('send','pageview');
        </script>
    </body>
</html>

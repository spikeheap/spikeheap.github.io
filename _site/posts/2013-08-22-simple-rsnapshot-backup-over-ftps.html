<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
        <style>
            body {
                padding-top: 50px;
                padding-bottom: 20px;
            }
        </style>
        <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Project name</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <form class="navbar-form navbar-right" role="form">
            <div class="form-group">
              <input type="text" placeholder="Email" class="form-control">
            </div>
            <div class="form-group">
              <input type="password" placeholder="Password" class="form-control">
            </div>
            <button type="submit" class="btn btn-success">Sign in</button>
          </form>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Simple Rsnapshot backup over FTPS</h1>
        <small>22 Aug 2013</small>
        <p></p>
      </div>
    </div>

    <div class="container">
      <!-- Example row of columns -->
      <div class="row">
        <div class="col-xs-12">
          <p>In this post I’ll walk you through setting up a simple backup solution using Rsnapshot and CurlFTPfs to retrieve files from an FTP/FTPS server. The result is a flexible backup solution with multiple retrieval points.</p>

<p><em>Note that while this example will work with FTP it is not recommended because the protocol is not encrypted.</em></p>

<p><strong>Update 23/08/2013:</strong> There were a hundred other things I wanted to talk about in this post but decided to leave out for the sake of simplicity, but as <a href="https://twitter.com/m0untainpenguin">@m0untainpenguin</a> <a href="https://twitter.com/m0untainpenguin/statuses/370901452648374272">points out</a> the feeling of safety that hard links give you is misleading. There is only ever one copy of the file on disk, so if that gets corrupted you’re out of luck. A great reason to do regular full backups, but that’s a walkthrough for another post!<br />
<!--more--></p>

<p>I have tested this on a clean installation of Ubuntu 13.04, but let me know if anything doesn’t work as expected in the comments.</p>

<p><strong>Many of the commands within this tutorial must be executed as root. You can always just add “sudo” in front of it if you have problems.</strong></p>

<h1 id="a-simple-ftp-server-for-testing">A simple FTP server for testing</h1>

<p>While not technically part of the setup, I didn’t have ready access to an FTP server to test these notes. Installing an FTP server for testing is as simple as:</p>

<pre><code class="language-bash">apt-get install vsftpd
</code></pre>

<p>Out of the box, vsftpd serves your home directory and can be connected to using your standard username and password.</p>

<p><strong>Installing an FTP server with access to your home directory is a pretty bad idea without <a href="https://help.ubuntu.com/community/vsftpd#TLS.2BAC8-SSL.2BAC8-FTPS">configuring it properly</a></strong></p>

<h1 id="users-and-groups">Users and groups</h1>

<p>We don’t want the backup to run as root because it’s always a good idea to restrict things as much as possible, so let’s create a backup user and group:</p>

<pre><code class="language-bash">addgroup backup
adduser rsnapshot --ingroup backup --disabled-password
</code></pre>

<h1 id="mounting-an-ftp-folder-locally">Mounting an FTP folder locally</h1>

<p><a href="http://curlftpfs.sourceforge.net/">CurlFTPfs</a> presents the FTP server as a local directory using FUSE. It’s trivial to install it:</p>

<pre><code class="language-bash">apt-get install curlftpfs 
</code></pre>

<p>We want to connect to our remote server using credentials, so let’s add that to the <em>.netrc</em> file in the home directory of the backup user:</p>

<pre><code class="language-bash">cat &lt;&lt; EOF &gt; /home/rsnapshot/.netrc
machine ftp.host.com  
login myuser  
password mypass 
EOF

# Don't let anyone else see your FTP credentials
chmod 600 /home/rsnapshot/.netrc
</code></pre>

<p>Mounting the remote directory is also straightforward, here we’ll use /media/remote_server. Note that by default the directory is only accessible to the user who mounted it.</p>

<pre><code class="language-bash">mkdir /media/remote_server
chown rsnapshot /media/remote_server

# Ubuntu doesn't have the right permissions on /etc/fuse.conf, so let's fix that
chmod 644 /etc/fuse.conf
</code></pre>

<p>Mounting and unmounting is easy:</p>

<pre><code class="language-bash"># mount
curlftpfs ftps://ftp.host.com /media/remote_server -r -o ssl

# unmount
fusermount -u /media/remote_server
</code></pre>

<p>Now you have the remote folder mounted locally we can move on to the backup solution.</p>

<h1 id="rsnapshot-configuration">Rsnapshot configuration</h1>
<p>Right, we’ll need to install Rsnapshot first.</p>

<pre><code class="language-bash">apt-get install rsnapshot
</code></pre>

<p>We’re going to keep our backups in <em>/var/rsnapshot</em> for this example, but feel free to put them wherever you like:</p>

<pre><code class="language-bash">mkdir -p /var/rsnapshot/private/snapshots
chmod 0700 /var/rsnapshot/private
chmod 0755 /var/rsnapshot/private/snapshots
chown -R rsnapshot /var/rsnapshot/
</code></pre>

<p>While we’re at it, let’s touch the log file and lock directory:</p>

<pre><code class="language-bash">touch /var/log/rsnapshot.log
chown rsnapshot /var/log/rsnapshot.log
mkdir /var/run/rsnapshot/
chown rsnapshot /var/run/rsnapshot/
</code></pre>

<p>Next we need to set the configuration file. There are many options, so it’s a good idea to <a href="http://www.rsnapshot.org/rsnapshot.html">read the documentation</a>, but this will get you up and running:</p>

<gist>spikeheap/7901408

Now we can test the configuration (be sure to run as the rsnapshot user):

```bash
rsnapshot -t sync
```

We could run it without *-t* to carry out a backup, however that'll fail right now because the FTP directory isn't mounted (yet).

We want to mount the FTP folder every time we do a backup, so we'll need a wrapper script to do that (/var/rsnapshot/doftpsync.sh):

```bash 
#!/bin/sh
# -r = mount read-only
# -o ssl = Force SSL
echo Mounting the FTP servr
curlftpfs ftps://ftp.host.com /media/remote_server -r -o ssl

# Do some backup here :)
#echo performing the backup
/usr/bin/rsnapshot sync

# Finally, unmount and disconnect from the FTP server
fusermount -u /media/remote_server
```

Make the script executable:

```bash
chmod 755 /var/rsnapshot/doftpsync.sh
```

And finally run the script to test it. Check the contents of /var/rsnapshot/private/snapshots to check it worked as expected.
# Running regularly with cron

As the backup user, let's execute the Rsnapshot command at the relevant intervals using cron. To edit the user's crontab just use:

```bash
su - rsnapshot
crontab -e
```

And add in the following commands (feel free to change the intervals to meet your needs of course):
 
```bash
# You only need to run 'sync' if the 'syncfirst' option is true
0 * * * *       /var/rsnapshot/doftpsync.sh

# Every hour on the 50th minute
50 * * * *       /usr/local/bin/rsnapshot hourly
# Once a day at 23:40
40 23 * * *       /usr/local/bin/rsnapshot daily
# Every Sunday at 23:30
30 23 * * 0       /usr/local/bin/rsnapshot weekly
# The first day of every month at 23:20
20 23 1 * *       /usr/local/bin/rsnapshot monthly
```


# Mounting a read-only backup for recovery (optional)

Having a read-only copy of your backup is a great idea. Having one that even root can't write to is even better. How much less stressful is it when you never have to think "damn, I copied that the wrong way and overwrote the backup". Fortunately it's easy to do with NFS (this is largely adapted and taken from the [Rsnapshot HOWTO](http://www.rsnapshot.org/howto/1.2/rsnapshot-HOWTO.en.pdf)). 

First we need to create a location to mount the read-only snapshots and modify the permissions so that no-one but the rsnapshot user can look inside the private directory:

```bash
mkdir /var/rsnapshot/readonly
chmod 0755 /var/rsnapshot/readonly
```

Then we add the NFS export of our private directory to */etc/exports*:

```bash
/var/rsnapshot/private/snapshots/ 127.0.0.1(ro,no_root_squash)
```

You'll need to restart the NFS service now:

```bash
service nfs restart
```

Now we have the NFS export, we can mount it. Add the following to */etc/fstab*:

```bash
localhost:/var/rsnapshot/private/snapshots/ /var/rsnapshot/readonly/ nfs ro 0 0
```

Finally you can mount the directory:

```bash
mount /var/rsnapshot/readonly/
```

And of course, to test! Try creating a file inside the */var/rsnapshot/readonly/* directory and watch it fail.

# Summary

You should now have a fully fledged enterprise-grade backup system making a backup of your hosted data, but there's no time to rest! Encrypting your external drive is a great idea, just in case it gets stolen. 

Of course you could always automate most of the above installation (and maintenance) by using Puppet and the [Rsnapshot module](https://github.com/spikeheap/puppet_rsnapshot). 
</gist>

        </div>
      </div>

      <hr>

      <footer>
        <p>&copy; Company 2014</p>
      </footer>
    </div> <!-- /container -->  
        <script src="/bower_components/jquery/dist/jquery.min.js"></script>
        <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-XXXXX-X');ga('send','pageview');
        </script>
    </body>
</html>

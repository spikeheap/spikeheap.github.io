<!DOCTYPE html><!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]--><!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]--><!--[if gt IE 8]><!--><html class=no-js><!--<![endif]--><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Cleaning up if-else regex matches in Perl with given-when</title><!-- facebook open graph tags --><meta property=og:type content=article><meta property=og:site_name content="Ryan Brooks' blog"><meta property=og:url content="https://www.ryanbrooks.co.uk/posts/2012-04-05-cleaning-up-if-else-regex-matches-in-perl-with-given-when/"><meta property=og:title content="Cleaning up if-else regex matches in Perl with given-when"><meta property=og:description content=""><!-- twitter card tags additive with the og: tags --><meta name=twitter:card content=summary><meta name=twitter:site content=@spikeheap><meta name=twitter:url value="https://www.ryanbrooks.co.uk/posts/2012-04-05-cleaning-up-if-else-regex-matches-in-perl-with-given-when/"><meta name=twitter:title value="Cleaning up if-else regex matches in Perl with given-when"><meta name=twitter:description value=""><meta name=twitter:label1 value="Reading time"><meta name=twitter:data1 value="ðŸ•’ 4 minutes"><meta name=viewport content="width=device-width, initial-scale=1"><link rel=alternate type=application/rss+xml title="Ryan Brooks' blog" href=https://www.ryanbrooks.co.uk/feed.xml><link rel=stylesheet href=/css/style.d41d.css><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-43110335-1');ga('send','pageview');</script><meta name=google-site-verification content=Ie2d0Oy5dhnMbWcw7qg7PIeq3Wiv9X7GoyyL9pz39Eo></head><body><!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]--><nav class="navbar navbar-default navbar-top"><div class=container><!-- Brand and toggle get grouped for better mobile display --><div class=navbar-header><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#bs-example-navbar-collapse-1><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a class=navbar-brand href="/">Ryan Brooks</a></div><!-- Collect the nav links, forms, and other content for toggling --><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav"><li><a href="/archives/">Blog archive</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a class="nav-fa-link target=" _blank="" href=https://github.com/spikeheap><i class="fa fa-2x fa-github-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=https://twitter.com/spikeheap><i class="fa fa-2x fa-twitter-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=http://uk.linkedin.com/in/ryanpbrooks><i class="fa fa-2x fa-linkedin-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=mailto:ryanbrooksis+info@gmail.com><i class="fa fa-2x fa-envelope-square"></i></a></li></ul></div><!-- /.navbar-collapse --></div></nav><div class=container><div class=row><div class=col-sm-9><h1 class=page-title>Cleaning up if-else regex matches in Perl with given-when</h1><span class=text-muted>05 Apr 2012</span>, <span class="reading-time text-muted">2 minute read</span><p></p><p>One of our applications written in Perl parses large text files to collect information about it. Weâ€™ve ended up applying it (over time) to various different areas, and weâ€™re now in a position where we create new versions regularly.</p><p>As we started re-using what was then a simple script, we took the obvious step to abstract the common code into a central library. Now weâ€™re not re-using code, the individual â€˜parserâ€™ scripts are effectively just if-else blocks matching the different lines:</p><div class="language-perl highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=k>use</span> <span class=nv>strict</span><span class=p>;</span>
<span class=k>use</span> <span class=nv>warnings</span><span class=p>;</span>

<span class=c1># For each line in the file</span>
<span class=k>my</span> <span class=nv>$line</span> <span class=o>=</span> <span class=nv>$_</span><span class=p>;</span>

<span class=k>if</span><span class=p>(</span><span class=k>my</span> <span class=p>(</span><span class=nv>$name</span><span class=p>,</span> <span class=nv>$age</span><span class=p>)</span> <span class=o>=</span> <span class=nv>$line</span> <span class=o>=~</span> <span class=sr>/My name is ([A-Za-z]+) and I am (\d+) years old/</span><span class=p>){</span>
	<span class=nv>$personbuilder</span><span class=o>-&gt;</span><span class=nv>addPerson</span><span class=p>(</span><span class=nv>$name</span><span class=p>,</span> <span class=nv>$age</span><span class=p>);</span>
<span class=p>}</span><span class=k>elsif</span><span class=p>(</span><span class=nv>$line</span> <span class=o>=~</span> <span class=sr>/I like Perl/</span><span class=p>){</span>
	<span class=nv>$personbuilder</span><span class=o>-&gt;</span><span class=nv>addPreference</span><span class=p>("</span><span class=s2>Perl</span><span class=p>");</span>
<span class=p>}</span>
<span class=c1># ... imagine a whole load more elsif statements here </span>
<span class=k>else</span><span class=p>{</span>
	<span class=nv>$logger</span><span class=o>-&gt;</span><span class=nv>error</span><span class=p>("</span><span class=s2>Line not matched: </span><span class=p>"</span><span class=o>+</span><span class=nv>$line</span><span class=p>);</span>
	<span class=nb>die</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div></div><p>The above is a contrived example, but line 3 demonstrates the problem of collecting multiple groups from the regular expression match. As the number of groups increases the whole line becomes a bit unreadable. The main problem is itâ€™s really easy to add an <em>if</em> rather than an <em>elsif</em> and your whole script breaks down.</p><p>So while I was doing some routine maintenance of a script the other day I found the Perl <strong>given/when</strong> construct. It doesnâ€™t have the advantage of being immediately recognisable to anyone whoâ€™s ever programmed, but is fairly intuitive:</p><div class="language-perl highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=k>use</span> <span class=nv>strict</span><span class=p>;</span>
<span class=k>use</span> <span class=nv>warnings</span><span class=p>;</span>
<span class=k>use</span> <span class=nv>v5</span><span class=mf>.10</span><span class=p>;</span>

<span class=k>for</span><span class=p>(</span><span class=k>my</span> <span class=nv>$i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&amp;</span><span class=ow>lt</span><span class=p>;</span> <span class=mi>10</span><span class=p>;</span> <span class=nv>$i</span><span class=o>++</span><span class=p>){</span>
	<span class=k>my</span> <span class=nv>$line</span> <span class=o>=</span> <span class=p>"</span><span class=s2>This contains </span><span class=si>$i</span><span class=s2> winnings for </span><span class=p>";</span>
	<span class=nv>$line</span> <span class=o>.=</span> <span class=p>"</span><span class=s2>the </span><span class=si>${i}</span><span class=s2>th winnner.</span><span class=p>";</span>
	
	<span class=k>if</span><span class=p>(</span><span class=nv>$i</span> <span class=o>%</span> <span class=mi>3</span> <span class=o>==</span> <span class=mi>0</span><span class=p>){</span>
		<span class=nv>$line</span> <span class=o>=</span> <span class=p>"</span><span class=s2>no dice</span><span class=p>";</span>
	<span class=p>}</span>	
	
	<span class=nv>given</span><span class=p>(</span><span class=nv>$line</span><span class=p>){</span>
		<span class=nv>when</span><span class=p>(</span><span class=sr>/This contains (\d+) winnings for (.*)/</span><span class=p>){</span>
			<span class=k>my</span> <span class=nv>$winnings</span> <span class=o>=</span> <span class=nv>$1</span><span class=p>;</span>
			<span class=k>my</span> <span class=nv>$winner</span> <span class=o>=</span> <span class=nv>$2</span><span class=p>;</span>
			<span class=k>print</span> <span class=p>"</span><span class=s2>Amount: </span><span class=p>"</span><span class=o>.</span><span class=nv>$winnings</span> <span class=o>.</span><span class=p>"</span><span class=se>\n</span><span class=p>";</span>
			<span class=k>print</span> <span class=p>"</span><span class=s2>Winner: </span><span class=p>"</span> <span class=o>.</span><span class=nv>$winner</span> <span class=o>.</span> <span class=p>"</span><span class=s2>.</span><span class=se>\n</span><span class=p>";</span>
		<span class=p>}</span>
		<span class=nv>when</span><span class=p>(</span><span class=sr>/no dice/</span><span class=p>){</span>
			<span class=k>print</span> <span class=p>"</span><span class=se>\t</span><span class=p>"</span><span class=o>.</span> <span class=nv>$_</span> <span class=o>.</span> <span class=p>"</span><span class=se>\n</span><span class=p>";</span>
		<span class=p>}</span>
		<span class=nv>default</span> <span class=p>{</span> 
			<span class=k>print</span> <span class=p>"</span><span class=s2>NOT MATCHED</span><span class=se>\n</span><span class=p>";</span>
		<span class=p>}</span> 
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div></div><p>The above code provides a nice safeguard in that a <em>when</em> can only mean one thing, and canâ€™t be swapped out for an <em>if</em>. Breaking it down into multiple <em>given</em> blocks is more obvious and requires more effort, so itâ€™s harder to introduce and easier to fix bugs.</p><p>The <em>when</em> statement uses Perlâ€™s smart matching feature, so you can use Strings, numbers, regular expressions or booleans, with some caveats about how clever it is. Read more here: <a href=http://perldoc.perl.org/perlsyn.html>http://perldoc.perl.org/perlsyn.html</a> and here: <a href=http://szabgab.com/smart-matching-in-perl-5.10.html>http://szabgab.com/smart-matching-in-perl-5.10.html</a></p><hr><div class=discussion><h1>Discuss!</h1><p>Was this post useful? Why not help others find it by sharing on <a href="https://twitter.com/intent/user?screen_name=spikeheap" target=_blank><i class="fa fa-twitter"></i> twitter</a>. While you're there, get in touch and let me know what you think!</p></div><div class=post-nav><a class="hidden-xs btn btn-sm btn-default pull-left half-width-max text-overflow" href="/posts/2012-04-04-blogging-about-software-using-textmate/"><i class="fa fa-arrow-circle-left"></i> Blogging about software using Textmate</a> <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2012-04-04-blogging-about-software-using-textmate/"><i class="fa fa-fw fa-arrow-circle-left"></i> Blogging about software using Textmate</a> <a class="btn btn-sm btn-default hidden-xs pull-right half-width-max text-overflow" href="/posts/2012-04-05-maybe-my-search-4-2/">Using JIRA to manage a skills registry <i class="fa fa-arrow-circle-right"></i></a> <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2012-04-05-maybe-my-search-4-2/"><i class="fa fa-fw fa-arrow-circle-right"></i> Using JIRA to manage a skills registry</a> <span class=clearfix></span></div></div><div class="col-sm-3 border-left"><div class=bio><img src=/images/profile-400px.d912.jpg><h3>Hi, I'm Ryan</h3><p>I care about code, building great teams and the community. I run <a href=https://www.slatehorse.com>Slate Horse</a> but I'm still a full-stack developer. Previously co-organiser of <a href="http://jsoxford.com/">JSOxford</a> and <a href="http://oxrug.org/">OxRUG</a>.</p><hr><h4>Get in touch</h4><div class=contact-icons><a target=_blank href=https://twitter.com/spikeheap><i class="fa fa-2x fa-twitter-square"></i></a> <a target=_blank href=https://github.com/spikeheap><i class="fa fa-2x fa-github-square"></i></a> <a target=_blank href=http://uk.linkedin.com/in/ryanpbrooks><i class="fa fa-2x fa-linkedin-square"></i></a> <a target=_blank href=mailto:ryanbrooksis+info@gmail.com><i class="fa fa-2x fa-envelope-square"></i></a></div></div></div></div></div><footer class="container-fluid footer--bottom"><div class=container><small>&copy; Ryan Brooks. The content of this page is licensed under the Creative Commons Attribution 3.0 License.</small></div></footer><script src=/vendor/node_modules/jquery/dist/jquery.min.js></script><script src=/vendor/node_modules/bootstrap-sass/assets/javascripts/bootstrap.js></script></body></html>
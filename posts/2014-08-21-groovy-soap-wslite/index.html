<!DOCTYPE html><!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]--><!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]--><!--[if gt IE 8]><!--><html class=no-js><!--<![endif]--><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Groovy SOAP clients with ws-lite</title><!-- facebook open graph tags --><meta property=og:type content=article><meta property=og:site_name content="Ryan Brooks' blog"><meta property=og:url content="https://www.ryanbrooks.co.uk/posts/2014-08-21-groovy-soap-wslite/"><meta property=og:title content="Groovy SOAP clients with ws-lite"><meta property=og:description content=""><!-- twitter card tags additive with the og: tags --><meta name=twitter:card content=summary><meta name=twitter:site content=@spikeheap><meta name=twitter:url value="https://www.ryanbrooks.co.uk/posts/2014-08-21-groovy-soap-wslite/"><meta name=twitter:title value="Groovy SOAP clients with ws-lite"><meta name=twitter:description value=""><meta name=twitter:label1 value="Reading time"><meta name=twitter:data1 value="üïí 5 minutes"><meta name=viewport content="width=device-width, initial-scale=1"><link rel=alternate type=application/rss+xml title="Ryan Brooks' blog" href=https://www.ryanbrooks.co.uk/feed.xml><link rel=stylesheet href=/css/style.4a95.css><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-43110335-1');ga('send','pageview');</script><meta name=google-site-verification content=Ie2d0Oy5dhnMbWcw7qg7PIeq3Wiv9X7GoyyL9pz39Eo></head><body><!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]--><nav class="navbar navbar-default navbar-top"><div class=container><!-- Brand and toggle get grouped for better mobile display --><div class=navbar-header><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#bs-example-navbar-collapse-1><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a class=navbar-brand href="/">Ryan Brooks</a></div><!-- Collect the nav links, forms, and other content for toggling --><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav"><li><a href=/archives.html>Blog archive</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a class="nav-fa-link target=" _blank="" href=https://github.com/spikeheap><i class="fa fa-2x fa-github-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=https://twitter.com/spikeheap><i class="fa fa-2x fa-twitter-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=http://uk.linkedin.com/in/ryanpbrooks><i class="fa fa-2x fa-linkedin-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=mailto:ryanbrooksis+info@gmail.com><i class="fa fa-2x fa-envelope-square"></i></a></li></ul></div><!-- /.navbar-collapse --></div></nav><div class=container><div class=row><div class=col-sm-9><h1 class=page-title>Groovy SOAP clients with ws-lite</h1><span class=text-muted>21 Aug 2014</span>, <span class="reading-time text-muted">4 minute read</span><p></p><p>When we needed to quickly build a proof-of-concept to test a set of SOAP services I thought: ‚Äúthis is perfect for Groovy, and it‚Äôs DSL support will mean talking to SOAP won‚Äôt require stub generation or any of that pain‚Äù. I was almost right.</p><p><strong>TLDR;</strong> My client script is <a href=https://gist.github.com/spikeheap/b5428f11834a0cea3822>available as a GitHub gist</a> for cannibalisation.</p><!-- more --><p>SOAP is <em>almost</em> legacy, but it‚Äôs still the only way to interface with large enterprise systems, at least in healthcare. Just as I‚Äôve come to accept that CSV is <strong>the</strong> way everyone sends lab and patient records (when they‚Äôre not exporting to Excel sheets), I wasn‚Äôt surprised when our project with MirthResults and MirthConnect only had SOAP calls to add patients to a component. No problem, I thought, just Google ‚ÄúGroovy SOAP‚Äù and I‚Äôll be done in 10 minutes.</p><p>So, the top result is <a href=http://groovy.codehaus.org/Groovy+SOAP>the Groovy SOAP documentation</a>, which does say (although not very obviously) that it‚Äôs deprecated. That‚Äôs fine, it suggests its replacement, <a href=http://groovy.codehaus.org/GroovyWS>GroovyWS</a>. But that page tells you to ‚Äòbe careful‚Äô because the project is dormant. Not to worry, because it suggests looking at <a href=https://github.com/jwagenleitner/groovy-wslite>groovy-wslite</a>. I‚Äôm already feeling like I‚Äôm entering the rabbit hole.</p><p>Fortunately groovy-wslite is an active project and has commits (at the time of writing) from just over a month ago. The DSL is pretty straightforward so I set about connecting to the target WSDL and then added basic authentication. The documentation for the project is quite sparse, so this post is an attempt to bring together the bits that I needed.</p><p>If you need anything other than ‚ÄòBasic‚Äô HTTP autentication, stop right there. The project doesn‚Äôt seem to support ‚ÄòDigest‚Äô or ‚ÄòNTLM‚Äô authentication, so you might be better going for <a href=http://stackoverflow.com/questions/15940234/how-to-do-a-soap-web-service-call-from-java-class>plain Java SOAP</a>.</p><p>In a simple script, you can just grab the wslite dependency and connect in a couple of lines:</p><pre><code class=language-groovy>@Grab(group='com.github.groovy-wslite', module='groovy-wslite', version='1.1.0')
 
import groovy.xml.*
import wslite.soap.*
import wslite.http.auth.*
 
def client = new SOAPClient('https://mirthtest.local:11443/ClinicalDocumentWSService/ClinicalDocumentWS?wsdl')
client.authorization = new HTTPBasicAuthorization("username", "password")
</code></pre><p>It‚Äôs then trivially easy to do a SOAP call:</p><pre><code class=language-groovy>def response = client.send(
		connectTimeout:5000,
		readTimeout:20000,
		useCaches:false,
		followRedirects:false,
		sslTrustAllCerts:true) {
	envelopeAttributes "xmlns:ejb":"http://ejb.results.mirth.com/"
	body {
		"ejb:getSubjectGroupMemberIds" {
			subjectGroupId( 'MySubjectGroup' )
			subjectGroupStatusId( 'NEW' )
		}
	}
}
</code></pre><p>The response we get back contains a bit of extra information, so it‚Äôs worth checking the response code before ploughing on:</p><pre><code class=language-groovy>def returnVal
if(response.httpResponse.statusMessage=="OK") {
	returnVal = response.getSubjectGroupMemberIdsResponse.'return'
}
</code></pre><p>It‚Äôs worth noting that the response element is the name of the service call suffixed with ‚ÄòResponse‚Äô. We can then dump the XML in a readable form to the console if we like:</p><pre><code class=language-groovy>println XmlUtil.serialize(returnVal) // Obviously use a logger here instead :)
</code></pre><p>We can also interrogate the XML tree in the same way we would a normal object structure:</p><pre><code class=language-groovy>def memberCount = returnVal.results.list.size()
println "There are ${memberCount} members initially"
</code></pre><p>In the following gist I‚Äôve abstracted the SOAP call away into its own method and then created a method for each SOAP call to give me a quick and easy interface to demo the SOAP calls from the console. Feel free to fork, copy, adapt to your own needs.</p><noscript><pre>@Grab(group=&#39;com.github.groovy-wslite&#39;, module=&#39;groovy-wslite&#39;, version=&#39;1.1.0&#39;)

import groovy.xml.*
import wslite.soap.*
import wslite.http.auth.*

def client = new SOAPClient(&#39;https://dummy:11443/ClinicalDocumentWSService/ClinicalDocumentWS?wsdl&#39;)
client.authorization = new HTTPBasicAuthorization(&quot;mirth&quot;, &quot;password&quot;)

// Grab the latest member list
def members = getSubjectGroupMemberIds(client, &#39;GROUP001&#39;, &#39;NEW&#39;).results
def memberCount = members.list.size()
println &quot;There are ${memberCount} members initially&quot;

// Get a patient
def retrievedSubject = getPatientsByFilterWithoutClinicalItems(client, {
    firstName(&quot;Bob&quot;)
    lastName(&quot;Bunting&quot;)
    numRows(1)
  }) 
def subjectId = retrievedSubject.results.list.id
println &quot;Subject ID: ${subjectId}, name: ${retrievedSubject.results.list.name.first} ${retrievedSubject.results.list.name.middle} ${retrievedSubject.results.list.name.last}&quot;

// Add the patient to the subjects of interest list (NEW, ACTIVE, EXCLUDED, RETIRED)
println XmlUtil.serialize( createSubjectGroupMember(client, &#39;GROUP001&#39;, &#39;NEW&#39;, &#39;MYSTATUS&#39;, subjectId) )

// Grab the latest member list
members = getSubjectGroupMemberIds(client, &#39;GROUP001&#39;, &#39;NEW&#39;).results
assert  members.list.size() == (memberCount + 1)

println XmlUtil.serialize(members)


// SOAP call methods

def getSubjectGroupMemberIds(client, groupId, groupStatusId){
  doSOAPRequest( client, &#39;getSubjectGroupMemberIds&#39;, {
    subjectGroupId( groupId )
    subjectGroupStatusId( groupStatusId )
  })
}

/**
 * Typically search by forename, surname, dob and gender
 * also by patient alias (NHS # or MRN #)
 **/
def getPatientsByFilterWithoutClinicalItems(client, subjectFilter){
  doSOAPRequest( client, &#39;getPatientsByFilterWithoutClinicalItems&#39;, {
    subjectFilterModel subjectFilter
  })
}


def createSubjectGroupMember(client, groupId, groupStatusId, recFacilityId, patientId){
  doSOAPRequest( client, &#39;createSubjectGroupMember&#39;, {
    subjectGroupId( groupId )
    subjectGroupStatusId( groupStatusId )
    subjectId( patientId )
    receivingFacilityId ( recFacilityId )
    createSubjectGroupMemberExt( 0 ) // &#39;0&#39; causes an update to fail silently if it exists already.
  })
}


/**
 * Do a SOAP request with the given command and payload.
 * Doesn&#39;t massage the payload, this method is just to reduce copy/paste for the SOAP request.
 **/
def doSOAPRequest(client, command, commandBody){
  def response = client.send(
                           connectTimeout:5000,
                           readTimeout:20000,
                           useCaches:false,
                           followRedirects:false,
                           sslTrustAllCerts:true) {
    envelopeAttributes &quot;xmlns:ejb&quot;:&quot;http://ejb.results.mirth.com/&quot;
    body {
        &quot;ejb:${command}&quot;(commandBody)
    }
  }
  okStatus(response) ? response.&quot;${command}Response&quot;.&#39;return&#39; : null
}


/**
 * Check that the HTTP response is good.
 * Shamelessly lifted from https://confluence.sakaiproject.org/display/WEBSVCS/WS-Groovy
 **/
def okStatus( SOAPResponse response ){
  return response.httpResponse.statusMessage==&quot;OK&quot;
}
</pre></noscript><script src=https://gist.github.com/spikeheap/b5428f11834a0cea3822.js></script><hr><div class=discussion><h1>Discuss!</h1><p>Was this post useful? Why not help others find it by sharing on <a href="https://twitter.com/intent/user?screen_name=spikeheap" target=_blank><i class="fa fa-twitter"></i> twitter</a>. While you're there, get in touch and let me know what you think!</p></div><div class=post-nav><a class="hidden-xs btn btn-sm btn-default pull-left half-width-max text-overflow" href="/posts/2014-08-06-code-retreat-thoughts/"><i class="fa fa-arrow-circle-left"></i> Oxford's Summer of Hacks 2014 ‚Äì Code Retreat</a> <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2014-08-06-code-retreat-thoughts/"><i class="fa fa-fw fa-arrow-circle-left"></i> Oxford's Summer of Hacks 2014 ‚Äì Code Retreat</a> <a class="btn btn-sm btn-default hidden-xs pull-right half-width-max text-overflow" href="/posts/2014-08-27-jsoxford-nodebots-day/">JSOxford NodeBots, August 2014 <i class="fa fa-arrow-circle-right"></i></a> <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2014-08-27-jsoxford-nodebots-day/"><i class="fa fa-fw fa-arrow-circle-right"></i> JSOxford NodeBots, August 2014</a> <span class=clearfix></span></div></div><div class="col-sm-3 border-left"><div class=bio><img src=/images/profile-400px.d912.jpg><h3>Hi, I'm Ryan</h3><p>I care about code, building great teams and the community. I run <a href=https://www.slatehorse.com>Slate Horse</a> but I'm still a full-stack developer. Previously co-organiser of <a href="http://jsoxford.com/">JSOxford</a> and <a href="http://oxrug.org/">OxRUG</a>.</p><hr><h4>Get in touch</h4><div class=contact-icons><a target=_blank href=https://twitter.com/spikeheap><i class="fa fa-2x fa-twitter-square"></i></a> <a target=_blank href=https://github.com/spikeheap><i class="fa fa-2x fa-github-square"></i></a> <a target=_blank href=http://uk.linkedin.com/in/ryanpbrooks><i class="fa fa-2x fa-linkedin-square"></i></a> <a target=_blank href=mailto:ryanbrooksis+info@gmail.com><i class="fa fa-2x fa-envelope-square"></i></a></div></div></div></div></div><footer class="container-fluid footer--bottom"><div class=container><small>&copy; Ryan Brooks. The content of this page is licensed under the Creative Commons Attribution 3.0 License.</small></div></footer><script src=/node_modules/jquery/dist/jquery.min.js></script><script src=/node_modules/bootstrap-sass/assets/javascripts/bootstrap.js></script></body></html>
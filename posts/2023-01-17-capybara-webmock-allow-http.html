<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-GB" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Capybara, WebMock, and too many open files - Ryan Brooks‚Äô blog</title>
<meta name="description" content="Working around">


  <meta name="author" content="Ryan Brooks">
  
  <meta property="article:author" content="Ryan Brooks">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_GB">
<meta property="og:site_name" content="Ryan Brooks' blog">
<meta property="og:title" content="Capybara, WebMock, and too many open files">
<meta property="og:url" content="https://www.ryanbrooks.co.uk/posts/2023-01-17-capybara-webmock-allow-http.html">


  <meta property="og:description" content="Working around">







  <meta property="article:published_time" content="2023-01-17T00:00:00+00:00">






<link rel="canonical" href="https://www.ryanbrooks.co.uk/posts/2023-01-17-capybara-webmock-allow-http.html">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Ryan Brooks' blog Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Ryan Brooks' blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/prev"
                
                
              >Previously</a>
            </li><li class="masthead__menu-item">
              <a
                href="/now"
                
                
              >Now</a>
            </li><li class="masthead__menu-item">
              <a
                href="/posts-by-year/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://www.ryanbrooks.co.uk/">
        <img src="/images/ryan_brooks_peak_autumn_2020.jpg" alt="Ryan Brooks" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://www.ryanbrooks.co.uk/" itemprop="url">Ryan Brooks</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>CTO with a dev &amp; ops origin story. Camembert lover/buzzword hater. Ex JSOxford, OxRUG, MoJ, GDS. Only personal opinions here</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Sheffield, UK</span>
        </li>
      

      
        
          
        
          
            <li><a href="https://ruby.social/@spikeheap" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i><span class="label">Mastodon</span></a></li>
          
        
          
            <li><a href="https://github.com/spikeheap" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Capybara, WebMock, and too many open files">
    <meta itemprop="description" content="Getting set up with a new codebase is always a fun, sometimes head-scratching experience where you have to discern whether the issues you‚Äôre facing are because you missed some piece of documentation (or it was missing), or have some bug in your setup.">
    <meta itemprop="datePublished" content="2023-01-17T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://www.ryanbrooks.co.uk/posts/2023-01-17-capybara-webmock-allow-http.html" itemprop="url">Capybara, WebMock, and too many open files
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Getting set up with a new codebase is always a fun, sometimes head-scratching experience where you have to discern whether the issues you‚Äôre facing are because you missed some piece of documentation (or it was missing), or have some bug in your setup.</p>

<p>I had this recently, joining a team where I just couldn‚Äôt get our RSpec feature tests to run on a fresh machine and checkout. Many tests failed with ‚ÄúToo many open files‚Äù:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Failure/Error: initialize_tcp host, port, local_host, local_port

          Errno::EMFILE:
            Failed to open TCP connection to 127.0.0.1:9526 (Too many open files - socket(2) for 127.0.0.1 port 9526)
</code></pre></div></div>

<p>This led me to <a href="https://github.com/teamcapybara/capybara#gotchas">a gotcha in Capybara/WebMock</a> that was causing the error. I still have no idea why this affected my Ruby build on MacOS Ventura, but none of my colleagues ü§∑‚Äç‚ôÇÔ∏è.</p>

<p>The error occurs because <code class="language-plaintext highlighter-rouge">Net::HTTP</code> has separate <code class="language-plaintext highlighter-rouge">connect</code> and <code class="language-plaintext highlighter-rouge">request</code> phases, but WebMock was designed with <code class="language-plaintext highlighter-rouge">connect</code> being part of the <code class="language-plaintext highlighter-rouge">request</code> step. Because there‚Äôs no information about the request in the <code class="language-plaintext highlighter-rouge">connect</code> step (just the destination address), WebMock can‚Äôt decide whether to stub or pass through the connection at that point, so they made the design decision to delay <code class="language-plaintext highlighter-rouge">connect</code> until a request is made. This is the approach of many HTTP libraries, but not <code class="language-plaintext highlighter-rouge">Net::HTTP</code>.</p>

<p>Fixing the error appeared to be as simple as <a href="https://github.com/bblimke/webmock/blob/master/README.md#connecting-on-nethttpstart">setting <code class="language-plaintext highlighter-rouge">net_http_connect_on_start: true</code></a> to undo WebMock‚Äôs workaround for <code class="language-plaintext highlighter-rouge">Net::HTTP</code>, however this introduced a new SSL certificate error for a mocked request. This was curious, because the requests are supposed to be mocked, so we don‚Äôt expect any external connection to be made.</p>

<p>It turns out that setting <code class="language-plaintext highlighter-rouge">net_http_connect_on_start: true</code>  works around the Capybara gotcha by enabling all <code class="language-plaintext highlighter-rouge">Net::HTTP</code> connections to be made<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>, while still intercepting and mocking the <code class="language-plaintext highlighter-rouge">request</code>s appropriately. We happened to see an error because of an SSL certificate problem on a host we didn‚Äôt really want to connect to.</p>

<h2 id="scoping-eager-connections">Scoping eager connections</h2>
<p>Thankfully, <code class="language-plaintext highlighter-rouge">net_http_connect_on_start</code> is smarter than just accepting <code class="language-plaintext highlighter-rouge">true</code> or <code class="language-plaintext highlighter-rouge">false</code>. There are a <a href="https://github.com/bblimke/webmock/blob/833291d4ce2d5927a738f929db26b594bf4fa7f5/spec/unit/webmock_spec.rb#L61">bunch of tests showing</a> <code class="language-plaintext highlighter-rouge">net_http_connect_on_start</code> accepts:</p>
<ul>
  <li>Regular expression matching host</li>
  <li>Host</li>
  <li>Port</li>
  <li>Scheme (e.g. <code class="language-plaintext highlighter-rouge">http</code>, <code class="language-plaintext highlighter-rouge">https</code>)</li>
</ul>

<p>For our test suite, we disallow all connections <em>except</em> the Capybara server, so the working solution for us was to scope <code class="language-plaintext highlighter-rouge">net_http_connect_on_start</code> to match the allowed host:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">WebMock</span><span class="p">.</span><span class="nf">disallow_net_connect!</span><span class="p">(</span>
    <span class="ss">allow_localhost: </span><span class="kp">true</span><span class="p">,</span> 
    <span class="ss">allow: </span><span class="no">Capybara</span><span class="p">.</span><span class="nf">server_host</span><span class="p">,</span> 
    <span class="ss">net_http_connect_on_start: </span><span class="no">Capybara</span><span class="p">.</span><span class="nf">server_host</span>
  <span class="p">)</span>
</code></pre></div></div>

<p>For another gotcha: WebMock supports passing a list of hosts to <code class="language-plaintext highlighter-rouge">allow</code>, but this isn‚Äôt supported by <code class="language-plaintext highlighter-rouge">net_http_connect_on_start</code>, where you‚Äôll need a regular expression instead if you have multiple disparate hosts.</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>Mostly thanks to <a href="https://github.com/bblimke/webmock/issues/914#issuecomment-810134233">this comment</a>¬†<a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#rant" class="page__taxonomy-item p-category" rel="tag">rant</a><span class="sep">, </span>
    
      <a href="/tags/#update" class="page__taxonomy-item p-category" rel="tag">update</a>
    
    </span>
  </p>




        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2023-01-17T00:00:00+00:00">January 17, 2023</time></p>

      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Capybara%2C+WebMock%2C+and+too+many+open+files%20https%3A%2F%2Fwww.ryanbrooks.co.uk%2Fposts%2F2023-01-17-capybara-webmock-allow-http.html"
    class="btn btn--twitter"
    onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
    title="Share on Twitter"><i
      class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.ryanbrooks.co.uk%2Fposts%2F2023-01-17-capybara-webmock-allow-http.html"
    class="btn btn--linkedin"
    onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
    title="Share on LinkedIn"><i
      class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>

      
  <nav class="pagination">
    
      <a href="/posts/2023-01-16-docker-contexts.html" class="pagination--pager" title="Docker context switching
">Previous</a>
    
    
      <a href="/posts/2023-02-17-linting-branch-changes.html" class="pagination--pager" title="Incrementally linting a codebase with branch changes
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You May Also Enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2023-06-12-protect-yourself-first.html" rel="permalink">Protect yourself first
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">A common refrain in software engineering is to put your team before yourself. Also, put the customer first. Make sure you align with the organisation‚Äôs goals...</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2023-02-17-linting-branch-changes.html" rel="permalink">Incrementally linting a codebase with branch changes
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Update 26th February 2023: replaced xargs approach because it interfered with Pry local debugging.

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2023-01-16-docker-contexts.html" rel="permalink">Docker context switching
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Sometimes it‚Äôs useful to run multiple Docker contexts/daemons, e.g. if you‚Äôre running Docker Desktop and Lima, or local Kubernetes clusters.

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2022-12-19-leaving-twitter.html" rel="permalink">From Twitter to Mastodon
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">A lot of people are leaving Twitter right now, and there‚Äôs a lot of hyperbole to go with it. I don‚Äôt think it‚Äôs going to disappear overnight, or go down in f...</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://ruby.social/@spikeheap" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i> Mastodon</a></li>
        
      
        
          <li><a href="https://github.com/spikeheap" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 <a href="https://www.ryanbrooks.co.uk">Ryan Brooks' blog</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZVSM9FVFJ3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZVSM9FVFJ3', { 'anonymize_ip': true});
</script>








  </body>
</html>

<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-GB" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Migrating user avatars to circular crops, with ImageMagick - Ryan Brooks’ blog</title>
<meta name="description" content="Picture the scene: you have a few thousand users with avatars on your site. You want to change from a boring 4x3 photo to a cool and hip circular crop. You know it’ll look great for new users, but we don’t want to leave the existing ones behind.">


  <meta name="author" content="Ryan Brooks">
  
  <meta property="article:author" content="Ryan Brooks">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_GB">
<meta property="og:site_name" content="Ryan Brooks' blog">
<meta property="og:title" content="Migrating user avatars to circular crops, with ImageMagick">
<meta property="og:url" content="https://www.ryanbrooks.co.uk/posts/2015-09-05-imagemagick-circular-avatars.html">


  <meta property="og:description" content="Picture the scene: you have a few thousand users with avatars on your site. You want to change from a boring 4x3 photo to a cool and hip circular crop. You know it’ll look great for new users, but we don’t want to leave the existing ones behind.">







  <meta property="article:published_time" content="2015-09-05T00:00:00+00:00">






<link rel="canonical" href="https://www.ryanbrooks.co.uk/posts/2015-09-05-imagemagick-circular-avatars.html">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Ryan Brooks' blog Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Ryan Brooks' blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/prev"
                
                
              >Previously</a>
            </li><li class="masthead__menu-item">
              <a
                href="/now"
                
                
              >Now</a>
            </li><li class="masthead__menu-item">
              <a
                href="/posts-by-year/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://www.ryanbrooks.co.uk/">
        <img src="/images/ryan_brooks_peak_autumn_2020.jpg" alt="Ryan Brooks" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://www.ryanbrooks.co.uk/" itemprop="url">Ryan Brooks</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>CTO with a dev &amp; ops origin story. Camembert lover/buzzword hater. Ex JSOxford, OxRUG, MoJ, GDS. Only personal opinions here</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Sheffield, UK</span>
        </li>
      

      
        
          
        
          
            <li><a href="https://ruby.social/@spikeheap" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i><span class="label">Mastodon</span></a></li>
          
        
          
            <li><a href="https://github.com/spikeheap" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Migrating user avatars to circular crops, with ImageMagick">
    <meta itemprop="description" content="Edit (2019-04-23): Updated to replace compose_opacity with DstIn to preserve source image transparency. Thanks Chen Han!">
    <meta itemprop="datePublished" content="2015-09-05T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://www.ryanbrooks.co.uk/posts/2015-09-05-imagemagick-circular-avatars.html" itemprop="url">Migrating user avatars to circular crops, with ImageMagick
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p><strong>Edit (2019-04-23):</strong> Updated to replace <code class="language-plaintext highlighter-rouge">compose_opacity</code> with <code class="language-plaintext highlighter-rouge">DstIn</code> to preserve source image transparency. Thanks Chen Han!</p>

<p>Picture the scene: you have a few thousand users with avatars on your site. You want to change from a boring 4x3 photo to a cool and hip circular crop. You know it’ll look great for new users, but we don’t want to leave the existing ones behind.</p>

<p>Let’s imagine our current approach to user avatars is to accept any size and shape image. Because we’re sensible, we retain the originally uploaded image and generate a thumbnail to be used on the site which maintains the proportions but constrains the longest side to 100 pixels.</p>

<p>Our new UI requires circular images at three different sizes (icon, default and large avatars). We want to take this opportunity to generate thumbnails at these sizes (and x2 for Retina screens) so we can keep file sizes small and our site as fast as possible. Because we can <a href="http://www.abeautifulsite.net/how-to-make-rounded-images-with-css/">easily create circular masks with CSS</a>, we just need create square versions of the images, and we have a few options:</p>

<ol>
  <li>Stretch the image to fit a square. This is obviously a bad idea.</li>
  <li>Crop the top/bottom or left/right of the longest side to make the image square.</li>
  <li>Fit the entire image within the square, and pad the excess.</li>
</ol>

<p>In this case I believe option 2 gives the best outcome – no excess whitespace and wholly-filled circles, but our users didn’t have any of this in mind when they uploaded their images in the dim and distant past so we need to get an idea of how these changes will affect their existing images.</p>

<h4 id="image-dimensions">Image dimensions</h4>
<p>The first thing we can do is calculate the distribution of image proportions. This is useful alongside the assumption that squarer images are more likely to crop without losing the subject in the image.</p>

<p>ImageMagick has a set of handy command-line tools to help us with this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find avatar_images <span class="se">\</span>
  <span class="nt">-type</span> f <span class="se">\</span>
  <span class="nt">-not</span> <span class="nt">-name</span> <span class="s2">"thumb_*"</span> <span class="se">\</span>
  <span class="nt">-exec</span> identify <span class="se">\</span>
  <span class="nt">-format</span> %w<span class="se">\ </span>%h<span class="se">\\</span>n <span class="o">{}</span> <span class="se">\;</span> | <span class="nb">awk</span> <span class="s1">'{ print $1/$2 }'</span> | <span class="nb">sort</span> | <span class="nb">cut</span> <span class="nt">-c1</span>,2,3
</code></pre></div></div>

<p>In the above example we search the <code class="language-plaintext highlighter-rouge">avatar_images</code> directory, include all files, but filter out images we’ve generated in the past (prefixed with <code class="language-plaintext highlighter-rouge">thumb_</code>). The output will be a list of the image propotions as double values (e.g. 4/3 → 1.333, 6/9 → 0.666).</p>

<p>You can dump this list into Excel and <a href="http://www.excel-easy.com/examples/histogram.html">generate a histogram</a>, or just use it to highlight how many values are outside of ‘squarish’.</p>

<p>This approach can help if you have a very large set of user avatar images, but it doesn’t help us with the qualitative task of checking that they look ‘okay’ with the new circular crop.</p>

<h4 id="creating-an-avatar-montage-for-quick-visual-checking">Creating an avatar montage for quick visual checking</h4>

<p>Humans are really (really) good at recognising faces. They’re not so good at monotony, so walking through 10,000 users’ profile pages isn’t going to work very well. A montage of all the avatars on a single image works surprisingly well – even at smaller sizes the headless avatars or dodgy crops jumped out at us.</p>

<p>ImageMagick is all set up to generate our rounded avatar images:</p>

<p><strong>Edit (2019-04-23):</strong> I’ve updated this script to use <code class="language-plaintext highlighter-rouge">DstIn</code> instead of <code class="language-plaintext highlighter-rouge">compose_opacity</code>, to preserve source image transparency in the cropped, masked output. See <a href="http://www.imagemagick.org/Usage/compose/#duff-porter">the documentation</a> for more information about Duff Porter choices.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#/bin/sh</span>
convert <span class="nv">$1</span> <span class="se">\</span>
        <span class="nt">-resize</span> x800 <span class="nt">-resize</span> <span class="s1">'800x&lt;'</span>   <span class="nt">-resize</span> 50% <span class="se">\</span>
        <span class="nt">-gravity</span> center  <span class="nt">-crop</span> 400x400+0+0 +repage <span class="se">\</span>
        <span class="se">\(</span> +clone <span class="nt">-threshold</span> <span class="nt">-1</span> <span class="nt">-negate</span> <span class="nt">-fill</span> white <span class="nt">-draw</span> <span class="s2">"circle 200,200 200,0"</span> <span class="se">\)</span> <span class="se">\</span>
        <span class="nt">-compose</span> DstIn <span class="se">\</span>
        <span class="nt">-composite</span> <span class="se">\</span>
        <span class="nt">-auto-orient</span> <span class="se">\</span>
    cropped_<span class="k">${</span><span class="nv">1</span><span class="k">}</span>.png
</code></pre></div></div>

<p>This generates a circular mask, and overlays that on the cropped, centred image. Wrapping the above with <code class="language-plaintext highlighter-rouge">find</code> allows us to loop through and process all our images:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># assumes we've placed the above snippet crop_avatars.sh</span>
<span class="nb">mkdir </span>cropped_images
find ./images <span class="nt">-type</span> f <span class="nt">-exec</span> ./crop_avatars.sh <span class="o">{}</span> <span class="se">\;</span>
</code></pre></div></div>

<p>We now have a <code class="language-plaintext highlighter-rouge">cropped_images/</code> directory containing smaller, rounder versions of the images. All we need to do then is stitch them together, and once again ImageMagick is there for us:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>montage cropped_images/<span class="k">*</span> avatar_montage.png
</code></pre></div></div>

<p>After all of that you should end up with something like this:</p>

<p><img src="/images/2015-08-28_montage.jpg" alt="A montage of user avatars" /></p>

<p>Have fun with it, but don’t be surprised when everyone wants to see your new creation. For many organisations this could well be the first chance they’ve had to see many of their users, and a huge grid of (hopefully smiling) faces can be quite powerful.</p>

<h4 id="references">References</h4>

<p>The following pages were hugely helpful for figuring out how to achieve the different portions of ImageMagic magic:</p>

<ul>
  <li><a href="http://daemonsandagents.tumblr.com/post/108369306151/imagemagick-ways-of-cropping-an-image-to-a">http://daemonsandagents.tumblr.com/post/108369306151/imagemagick-ways-of-cropping-an-image-to-a
</a></li>
  <li><a href="http://www.imagemagick.org/Usage/resize/#space_fill">http://www.imagemagick.org/Usage/resize/#space_fill
</a></li>
  <li><a href="http://www.imagemagick.org/Usage/thumbnails/#fit_summery">http://www.imagemagick.org/Usage/thumbnails/#fit_summery
</a></li>
  <li><a href="http://www.imagemagick.org/Usage/crop/#crop_gravity">http://www.imagemagick.org/Usage/crop/#crop_gravity
</a></li>
  <li><a href="http://www.imagemagick.org/Usage/montage/">http://www.imagemagick.org/Usage/montage/
</a></li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#engineering" class="page__taxonomy-item p-category" rel="tag">engineering</a><span class="sep">, </span>
    
      <a href="/tags/#guide" class="page__taxonomy-item p-category" rel="tag">guide</a>
    
    </span>
  </p>




        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2015-09-05T00:00:00+00:00">September 5, 2015</time></p>

      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Migrating+user+avatars+to+circular+crops%2C+with+ImageMagick%20https%3A%2F%2Fwww.ryanbrooks.co.uk%2Fposts%2F2015-09-05-imagemagick-circular-avatars.html"
    class="btn btn--twitter"
    onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
    title="Share on Twitter"><i
      class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.ryanbrooks.co.uk%2Fposts%2F2015-09-05-imagemagick-circular-avatars.html"
    class="btn btn--linkedin"
    onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
    title="Share on LinkedIn"><i
      class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>

      
  <nav class="pagination">
    
      <a href="/posts/2015-08-28-kitematic-for-boot2docker-users.html" class="pagination--pager" title="Kitematic for boot2docker users
">Previous</a>
    
    
      <a href="/posts/2016-04-28-docker-speedy-dependencies.html" class="pagination--pager" title="Faster dependencies with Docker
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You May Also Enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2023-06-12-protect-yourself-first.html" rel="permalink">Protect yourself first
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">A common refrain in software engineering is to put your team before yourself. Also, put the customer first. Make sure you align with the organisation’s goals...</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2023-02-17-linting-branch-changes.html" rel="permalink">Incrementally linting a codebase with branch changes
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Update 26th February 2023: replaced xargs approach because it interfered with Pry local debugging.

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2023-01-17-capybara-webmock-allow-http.html" rel="permalink">Capybara, WebMock, and too many open files
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Getting set up with a new codebase is always a fun, sometimes head-scratching experience where you have to discern whether the issues you’re facing are becau...</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2023-01-16-docker-contexts.html" rel="permalink">Docker context switching
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Sometimes it’s useful to run multiple Docker contexts/daemons, e.g. if you’re running Docker Desktop and Lima, or local Kubernetes clusters.

</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://ruby.social/@spikeheap" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i> Mastodon</a></li>
        
      
        
          <li><a href="https://github.com/spikeheap" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 <a href="https://www.ryanbrooks.co.uk">Ryan Brooks' blog</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZVSM9FVFJ3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZVSM9FVFJ3', { 'anonymize_ip': true});
</script>








  </body>
</html>

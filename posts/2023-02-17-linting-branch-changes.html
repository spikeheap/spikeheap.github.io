<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-GB" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Incrementally linting a codebase with branch changes - Ryan Brooks‚Äô blog</title>
<meta name="description" content="While working on a project with a long history, we wanted to introduce a linter, incrementally improving the code as we made changes.">


  <meta name="author" content="Ryan Brooks">
  
  <meta property="article:author" content="Ryan Brooks">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_GB">
<meta property="og:site_name" content="Ryan Brooks' blog">
<meta property="og:title" content="Incrementally linting a codebase with branch changes">
<meta property="og:url" content="https://www.ryanbrooks.co.uk/posts/2023-02-17-linting-branch-changes.html">


  <meta property="og:description" content="While working on a project with a long history, we wanted to introduce a linter, incrementally improving the code as we made changes.">







  <meta property="article:published_time" content="2023-02-17T00:00:00+00:00">






<link rel="canonical" href="https://www.ryanbrooks.co.uk/posts/2023-02-17-linting-branch-changes.html">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Ryan Brooks' blog Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Ryan Brooks' blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/prev"
                
                
              >Previously</a>
            </li><li class="masthead__menu-item">
              <a
                href="/now"
                
                
              >Now</a>
            </li><li class="masthead__menu-item">
              <a
                href="/posts-by-year/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://www.ryanbrooks.co.uk/">
        <img src="/images/ryan_brooks_peak_autumn_2020.jpg" alt="Ryan Brooks" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://www.ryanbrooks.co.uk/" itemprop="url">Ryan Brooks</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>CTO with a dev &amp; ops origin story. Camembert lover/buzzword hater. Ex JSOxford, OxRUG, MoJ, GDS. Only personal opinions here</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Sheffield, UK</span>
        </li>
      

      
        
          
        
          
            <li><a href="https://ruby.social/@spikeheap" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i><span class="label">Mastodon</span></a></li>
          
        
          
            <li><a href="https://github.com/spikeheap" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Incrementally linting a codebase with branch changes">
    <meta itemprop="description" content="Update 26th February 2023: replaced xargs approach because it interfered with Pry local debugging.">
    <meta itemprop="datePublished" content="2023-02-17T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://www.ryanbrooks.co.uk/posts/2023-02-17-linting-branch-changes.html" itemprop="url">Incrementally linting a codebase with branch changes
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p><strong>Update 26th February 2023:</strong> replaced <code class="language-plaintext highlighter-rouge">xargs</code> approach because it interfered with Pry local debugging.</p>

<p>While working on a project with a long history, we wanted to introduce <a href="https://rubocop.org">Rubocop</a> to lint the codebase. Being a large project, enforcing linting on the entire codebase wasn‚Äôt feasible ‚Äì thousands of offences and over a thousand that aren‚Äôt auto-correctable.</p>

<p>üò±</p>

<p>Instead of spending a soul-crushing few days trawling through the offences or blocking pull requests until it‚Äôs all perfect, we can start by just improving the files we change. This is surprisingly high-value ‚Äì the files we change regularly quickly become ‚Äústandard‚Äù and the ones we never touch‚Ä¶ well it doesn‚Äôt matter if they‚Äôre linted if we never look at them.</p>

<p>Linting only the files that have changed is fairly straightforward. First we need to find the files that have changed (e.g. for the <code class="language-plaintext highlighter-rouge">main</code> branch). We can do this with <code class="language-plaintext highlighter-rouge">git diff</code> and filter for <code class="language-plaintext highlighter-rouge">A</code>dded, <code class="language-plaintext highlighter-rouge">M</code>odified, and <code class="language-plaintext highlighter-rouge">R</code>enamed files:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git diff <span class="nt">--name-only</span> <span class="nt">--diff-filter</span><span class="o">=</span>AMR main...
</code></pre></div></div>
<p>(thanks to <a href="https://stackoverflow.com/a/10641400/384693">this StackOverflow answer</a>) for inspiration.</p>

<p>Depending on our linter, we‚Äôll probably want to filter those files so we don‚Äôt confuse it. Rubocop will attempt to parse things like <code class="language-plaintext highlighter-rouge">.erb</code>, and it won‚Äôt have a good time. If we only want to process files that Rubocop thinks it can handle we can use:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rubocop <span class="nt">--only-recognized-files</span> <span class="nt">--autocorrect</span> <span class="nt">--</span> file_a.rb file_b.rb
</code></pre></div></div>

<p>We can put this together to get a one-line command that runs Rubocop over any files that have been added, modified, or renamed:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rubocop <span class="nt">-a</span> <span class="nt">--only-recognized-files</span> <span class="si">$(</span>git diff <span class="nt">--diff-filter</span><span class="o">=</span>AMR <span class="nt">--name-only</span> main...<span class="si">)</span>
</code></pre></div></div>

<blockquote>
  <p>An early version of this approach used <code class="language-plaintext highlighter-rouge">xargs</code> to pass files, however this doesn‚Äôt always play nicely with <a href="https://github.com/pry/pry">Pry</a>, rending the breakpoint non-interactive. I didn‚Äôt get to the bottom of that, let me know if you have any ideas on <a href="https://ruby.social/@spikeheap">Mastodon</a>.</p>
</blockquote>

<p>Then all that‚Äôs left to do is commit the changes with a suitable emoji üòò.</p>

<h2 id="why-not-use-an-editor-extension">Why not use an editor extension?</h2>

<p>Once you‚Äôve got a consistently linted codebase it makes a lot of sense to use editor extensions for <a href="https://editorconfig.org">EditorConfig</a>, Rubocop, or your linter of choice. These will auto-lint or <a href="https://marketplace.visualstudio.com/items?itemName=misogi.ruby-rubocop">highlight offences in your editor</a>, which prevents us from adding non-compliant code in the first place.</p>

<p>However they‚Äôre less helpful when you‚Äôre introducing linting because auto-linting a file you‚Äôve touched groups changes to code with linting modifications. This increases the complexity and cognitive load for both reviewers and future developers spelunking the codebase, possibly mid-way through debugging a tricky error.</p>

<p>In this case it‚Äôs friendlier to separate the Rubocop linting from other changes. This might mean separate PRs for linter fixes, or a separate commit in the same request.</p>

<h2 id="continuous-integration-is-your-friend">Continuous Integration is your friend</h2>

<p>Once the team is able to lint the codebase locally and apply fixes, the next step is to add that linting to your CI service to validate that pull requests consistently improve the codebase.</p>

<p>Depending on your CI service, you <em>may</em> want to make those checks non-blocking to start with. Your teammates who make a one line change in <em>that</em> thousand line file will be thankful!</p>

<p>We need to make our CI script a little smarter than the one we‚Äôve been running locally, because branches with no additions, modifications or removals will cause Rubocop to run over the entire codebase. There are a bunch of scenarios where this is true, for example removing legacy unused code or renaming a bunch of files.</p>

<p>To work around this we can check to see whether the list of changed files is empty before passing it to Rubocop:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CHANGED_FILES</span><span class="o">=</span><span class="si">$(</span>git diff <span class="nt">--diff-filter</span><span class="o">=</span>AMR <span class="nt">--name-only</span> main...<span class="si">)</span>

<span class="c"># -n checks whether the list of changed files is null, to prevent Rubocop from running over</span>
<span class="c"># the _whole_ codebase if we've only removed files from the branch</span>
<span class="o">[</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$CHANGED_FILES</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> bundle <span class="nb">exec </span>rubocop <span class="nt">--only-recognized-file-types</span> <span class="si">$(</span><span class="nb">echo</span> <span class="nv">$CHANGED_FILES</span><span class="si">)</span>
</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#engineering" class="page__taxonomy-item p-category" rel="tag">engineering</a><span class="sep">, </span>
    
      <a href="/tags/#ruby" class="page__taxonomy-item p-category" rel="tag">ruby</a>
    
    </span>
  </p>




        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2023-02-17T00:00:00+00:00">February 17, 2023</time></p>

      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Incrementally+linting+a+codebase+with+branch+changes%20https%3A%2F%2Fwww.ryanbrooks.co.uk%2Fposts%2F2023-02-17-linting-branch-changes.html"
    class="btn btn--twitter"
    onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
    title="Share on Twitter"><i
      class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.ryanbrooks.co.uk%2Fposts%2F2023-02-17-linting-branch-changes.html"
    class="btn btn--linkedin"
    onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
    title="Share on LinkedIn"><i
      class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>

      
  <nav class="pagination">
    
      <a href="/posts/2023-01-17-capybara-webmock-allow-http.html" class="pagination--pager" title="Capybara, WebMock, and too many open files
">Previous</a>
    
    
      <a href="/posts/2023-06-12-protect-yourself-first.html" class="pagination--pager" title="Protect yourself first
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You May Also Enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2023-06-12-protect-yourself-first.html" rel="permalink">Protect yourself first
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">A common refrain in software engineering is to put your team before yourself. Also, put the customer first. Make sure you align with the organisation‚Äôs goals...</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2023-01-17-capybara-webmock-allow-http.html" rel="permalink">Capybara, WebMock, and too many open files
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Getting set up with a new codebase is always a fun, sometimes head-scratching experience where you have to discern whether the issues you‚Äôre facing are becau...</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2023-01-16-docker-contexts.html" rel="permalink">Docker context switching
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Sometimes it‚Äôs useful to run multiple Docker contexts/daemons, e.g. if you‚Äôre running Docker Desktop and Lima, or local Kubernetes clusters.

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2022-12-19-leaving-twitter.html" rel="permalink">From Twitter to Mastodon
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">A lot of people are leaving Twitter right now, and there‚Äôs a lot of hyperbole to go with it. I don‚Äôt think it‚Äôs going to disappear overnight, or go down in f...</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://ruby.social/@spikeheap" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i> Mastodon</a></li>
        
      
        
          <li><a href="https://github.com/spikeheap" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 <a href="https://www.ryanbrooks.co.uk">Ryan Brooks' blog</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZVSM9FVFJ3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZVSM9FVFJ3', { 'anonymize_ip': true});
</script>








  </body>
</html>

<!DOCTYPE html><!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]--><!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]--><!--[if gt IE 8]><!--><html class=no-js><!--<![endif]--><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Migrating user avatars to circular crops, with ImageMagick</title><!-- facebook open graph tags --><meta property=og:type content=article><meta property=og:site_name content="Ryan Brooks' blog"><meta property=og:url content="/posts/2015-09-05-imagemagick-circular-avatars/"><meta property=og:title content="Migrating user avatars to circular crops, with ImageMagick"><meta property=og:description content=""><!-- twitter card tags additive with the og: tags --><meta name=twitter:card content=summary><meta name=twitter:site content=@spikeheap><meta name=twitter:url value="/posts/2015-09-05-imagemagick-circular-avatars/"><meta name=twitter:title value="Migrating user avatars to circular crops, with ImageMagick"><meta name=twitter:description value=""><meta name=twitter:label1 value=ðŸ•’><meta name=twitter:data1 value="5 minutes"><meta name=viewport content="width=device-width, initial-scale=1"><link rel=alternate type=application/rss+xml title="Ryan Brooks' blog" href=http://ryanbrooks.co.uk/feed.xml><link rel=stylesheet href=/css/style.4ebd.css><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-43110335-1');ga('send','pageview');</script><meta name=google-site-verification content=Ie2d0Oy5dhnMbWcw7qg7PIeq3Wiv9X7GoyyL9pz39Eo></head><body><!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]--><nav class="navbar navbar-default navbar-top"><div class=container><!-- Brand and toggle get grouped for better mobile display --><div class=navbar-header><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#bs-example-navbar-collapse-1><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a class=navbar-brand href="/">Ryan Brooks</a></div><!-- Collect the nav links, forms, and other content for toggling --><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav"><li><a href=/archives.html>Blog archive</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a class="nav-fa-link target=" _blank="" href=https://github.com/spikeheap><i class="fa fa-2x fa-github-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=https://twitter.com/spikeheap><i class="fa fa-2x fa-twitter-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=http://uk.linkedin.com/in/ryanpbrooks><i class="fa fa-2x fa-linkedin-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=mailto:ryanbrooksis+info@gmail.com><i class="fa fa-2x fa-envelope-square"></i></a></li></ul></div><!-- /.navbar-collapse --></div></nav><div class=container><div class=row><div class=col-sm-9><h1 class=page-title>Migrating user avatars to circular crops, with ImageMagick</h1><span class=text-muted>05 Sep 2015</span><p></p><p>Picture the scene: you have a few thousand users with avatars on your site. You want to change from a boring 4x3 photo to a cool and hip circular crop. You know itâ€™ll look great for new users, but we donâ€™t want to leave the existing ones behind. <!-- more --></p><p>Letâ€™s imagine our current approach to user avatars is to accept any size and shape image. Because weâ€™re sensible, we retain the originally uploaded image and generate a thumbnail to be used on the site which maintains the proportions but constrains the longest side to 100 pixels.</p><p>Our new UI requires circular images at three different sizes (icon, default and large avatars). We want to take this opportunity to generate thumbnails at these sizes (and x2 for Retina screens) so we can keep file sizes small and our site as fast as possible. Because we can <a href="http://www.abeautifulsite.net/how-to-make-rounded-images-with-css/">easily create circular masks with CSS</a>, we just need create square versions of the images, and we have a few options:</p><ol><li>Stretch the image to fit a square. This is obviously a bad idea.</li><li>Crop the top/bottom or left/right of the longest side to make the image square.</li><li>Fit the entire image within the square, and pad the excess.</li></ol><p>In this case I believe option 2 gives the best outcome â€“ no excess whitespace and wholly-filled circles, but our users didnâ€™t have any of this in mind when they uploaded their images in the dim and distant past so we need to get an idea of how these changes will affect their existing images.</p><h4 id=image-dimensions>Image dimensions</h4><p>The first thing we can do is calculate the distribution of image proportions. This is useful alongside the assumption that squarer images are more likely to crop without losing the subject in the image.</p><p>ImageMagick has a set of handy command-line tools to help us with this:</p><pre><code class=language-bash>find avatar_images \
  -type f \
  -not -name "thumb_*" \
  -exec identify \
  -format %w\ %h\\n {} \; | awk '{ print $1/$2 }' | sort | cut -c1,2,3
</code></pre><p>In the above example we search the <code>avatar_images</code> directory, include all files, but filter out images weâ€™ve generated in the past (prefixed with <code>thumb_</code>). The output will be a list of the image propotions as double values (e.g. 4/3 â†’ 1.333, 6/9 â†’ 0.666).</p><p>You can dump this list into Excel and <a href=http://www.excel-easy.com/examples/histogram.html>generate a histogram</a>, or just use it to highlight how many values are outside of â€˜squarishâ€™.</p><p>This approach can help if you have a very large set of user avatar images, but it doesnâ€™t help us with the qualitative task of checking that they look â€˜okayâ€™ with the new circular crop.</p><h4 id=creating-an-avatar-montage-for-quick-visual-checking>Creating an avatar montage for quick visual checking</h4><p>Humans are really (really) good at recognising faces. Theyâ€™re not so good at monotony, so walking through 10,000 usersâ€™ profile pages isnâ€™t going to work very well. A montage of all the avatars on a single image works surprisingly well â€“ even at smaller sizes the headless avatars or dodgy crops jumped out at us.</p><p>ImageMagick is all set up to generate our rounded avatar images:</p><pre><code class=language-bash>#/bin/sh
convert $1 \
        -resize x800 -resize '800x&lt;'   -resize 50% \
        -gravity center  -crop 400x400+0+0 +repage \
        \( +clone -threshold -1 -negate -fill white -draw "circle 200,200 200,0" \) \
                -alpha off -compose copy_opacity -composite \
                \-auto-orient \
    cropped_${1}.png
</code></pre><p>This generates a circular mask, and overlays that on the cropped, centred image. Wrapping the above with <code>find</code> allows us to loop through and process all our images:</p><pre><code class=language-bash># assumes we've placed the above snippet crop_avatars.sh
mkdir cropped_images
find ./images -type f -exec ./crop_avatars.sh {} \;
</code></pre><p>We now have a <code>cropped_images/</code> directory containing smaller, rounder versions of the images. All we need to do then is stitch them together, and once again ImageMagick is there for us:</p><pre><code class=language-bash>montage cropped_images/* avatar_montage.png
</code></pre><p>After all of that you should end up with something like this:</p><p><img src=/images/posts/2015-08-28_montage.3eba.jpg alt="A montage of user avatars"></p><p>Have fun with it, but donâ€™t be surprised when everyone wants to see your new creation. For many organisations this could well be the first chance theyâ€™ve had to see many of their users, and a huge grid of (hopefully smiling) faces can be quite powerful.</p><h4 id=references>References</h4><p>The following pages were hugely helpful for figuring out how to achieve the different portions of ImageMagic magic:</p><ul><li>http://daemonsandagents.tumblr.com/post/108369306151/imagemagick-ways-of-cropping-an-image-to-a</li><li>http://www.imagemagick.org/Usage/resize/#space_fill</li><li>http://www.imagemagick.org/Usage/thumbnails/#fit_summery</li><li>http://www.imagemagick.org/Usage/crop/#crop_gravity</li><li>http://www.imagemagick.org/Usage/montage/</li></ul><hr><p>Was this post useful? Why not help others find it by sharing on <a href="https://twitter.com/intent/user?screen_name=spikeheap" target=_blank><i class="fa fa-twitter"></i> twitter</a>. While you're there, get in touch and let me know what you think!</p><div class=post-nav><a class="hidden-xs btn btn-sm btn-default pull-left half-width-max text-overflow" href="/posts/2015-08-28-kitematic-for-boot2docker-users/"><i class="fa fa-arrow-circle-left"></i> Kitematic for boot2docker users</a> <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2015-08-28-kitematic-for-boot2docker-users/"><i class="fa fa-fw fa-arrow-circle-left"></i> Kitematic for boot2docker users</a> <a class="btn btn-sm btn-default hidden-xs pull-right half-width-max text-overflow" href="/posts/2016-04-28-docker-speedy-dependencies/">Speedier dependencies with Docker <i class="fa fa-arrow-circle-right"></i></a> <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2016-04-28-docker-speedy-dependencies/"><i class="fa fa-fw fa-arrow-circle-right"></i> Speedier dependencies with Docker</a> <span class=clearfix></span></div><div id=disqus_thread></div><!-- Disqus comments --><script type=text/javascript>/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'ryanbrooks'; // required: replace example with your forum shortname
    var disqus_identifier = 'posts-2015-09-05-imagemagick-circular-avatars';
    var disqus_title = 'Migrating user avatars to circular crops, with ImageMagick';
    var disqus_url = 'http://ryanbrooks.co.uk/posts/2015-09-05-imagemagick-circular-avatars/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><div class="col-sm-3 border-left"><div class=bio><img src=/images/profile-400px.7d5e.jpg><h3>Hi, I'm Ryan</h3><p>I care about code, building great teams and the community. I run <a href=https://www.slatehorse.com>Slate Horse</a> but I'm still a full-stack developer, and co-organiser of <a href="http://jsoxford.com/">JSOxford</a> and <a href="http://oxrug.org/">OxRUG</a>.</p><hr><h4>Get in touch</h4><div class=contact-icons><a target=_blank href=https://twitter.com/spikeheap><i class="fa fa-2x fa-twitter-square"></i></a> <a target=_blank href=https://github.com/spikeheap><i class="fa fa-2x fa-github-square"></i></a> <a target=_blank href=http://uk.linkedin.com/in/ryanpbrooks><i class="fa fa-2x fa-linkedin-square"></i></a> <a target=_blank href=mailto:ryanbrooksis+info@gmail.com><i class="fa fa-2x fa-envelope-square"></i></a></div></div></div></div></div><footer class="container-fluid footer--bottom"><div class=container><small>&copy; Ryan Brooks. The content of this page is licensed under the Creative Commons Attribution 3.0 License.</small></div></footer><script src=/bower_components/jquery/dist/jquery.min.js></script><script src=/bower_components/bootstrap-sass/assets/javascripts/bootstrap.js></script></body></html>
<!DOCTYPE html><!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]--><!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]--><!--[if gt IE 8]><!--><html class=no-js><!--<![endif]--><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>A simple HTTPS proxy with Nginx on Docker</title><meta name=description content="Add a lightweight nginx container to your Docker setup to test HTTPS-related things."><!-- facebook open graph tags --><meta property=og:type content=article><meta property=og:site_name content="Ryan Brooks' blog"><meta property=og:url content="https://www.ryanbrooks.co.uk/posts/2016-05-19-nginx-docker-proxy/"><meta property=og:title content="A simple HTTPS proxy with Nginx on Docker"><meta property=og:description content="Add a lightweight nginx container to your Docker setup to test HTTPS-related things."><!-- twitter card tags additive with the og: tags --><meta name=twitter:card content=summary><meta name=twitter:site content=@spikeheap><meta name=twitter:url value="https://www.ryanbrooks.co.uk/posts/2016-05-19-nginx-docker-proxy/"><meta name=twitter:title value="A simple HTTPS proxy with Nginx on Docker"><meta name=twitter:description value="Add a lightweight nginx container to your Docker setup to test HTTPS-related things."><meta name=twitter:label1 value="Reading time"><meta name=twitter:data1 value="ðŸ•’ 5 minutes"><meta name=viewport content="width=device-width, initial-scale=1"><link rel=alternate type=application/rss+xml title="Ryan Brooks' blog" href=https://www.ryanbrooks.co.uk/feed.xml><link rel=stylesheet href=/css/style.d41d.css><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-43110335-1');ga('send','pageview');</script><meta name=google-site-verification content=Ie2d0Oy5dhnMbWcw7qg7PIeq3Wiv9X7GoyyL9pz39Eo></head><body><!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]--><nav class="navbar navbar-default navbar-top"><div class=container><!-- Brand and toggle get grouped for better mobile display --><div class=navbar-header><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#bs-example-navbar-collapse-1><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a class=navbar-brand href="/">Ryan Brooks</a></div><!-- Collect the nav links, forms, and other content for toggling --><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav"><li><a href="/archives/">Blog archive</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a class="nav-fa-link target=" _blank="" href=https://github.com/spikeheap><i class="fa fa-2x fa-github-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=https://twitter.com/spikeheap><i class="fa fa-2x fa-twitter-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=http://uk.linkedin.com/in/ryanpbrooks><i class="fa fa-2x fa-linkedin-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=mailto:ryanbrooksis+info@gmail.com><i class="fa fa-2x fa-envelope-square"></i></a></li></ul></div><!-- /.navbar-collapse --></div></nav><div class=container><div class=row><div class=col-sm-9><h1 class=page-title>A simple HTTPS proxy with Nginx on Docker</h1><span class=text-muted>19 May 2016</span>, <span class="reading-time text-muted">4 minute read</span><p></p><p>There are many reasons why you might need to develop behind an HTTPS proxy, for example when testing integrations which behave differently based on the security of your site. This post describes how to add an nginx proxy to your docker setup.</p><!-- more --><h3 id=tldr>TL;DR</h3><p>I know, you probably donâ€™t care about the back-story, you just want the code. If thatâ€™s you, this is all you need:</p><ol><li>This isnâ€™t production-quality. Mirror your production environment if you can.</li><li>The <code class=highlighter-rouge>Dockerfile</code> and <code class=highlighter-rouge>nginx.conf</code> are in <a href=https://gist.github.com/spikeheap/488929887d22e74783a5f4f982981a84>this gist</a>.</li><li>This assumes youâ€™ve got a <code class=highlighter-rouge>rails</code> container linked through docker-compose. Tweak it to your needs.</li><li>See [1].</li></ol><h3 id=background>Background</h3><p>Not so long back I was working on a Dropbox OAuth integration. This sent the user off to Dropbox to approve and connect their account to us before redirecting back to our site to continue the process. Dropbox have rules in place to protect users from accidentally exposing their details on insecure sites and push developers to secure their work. One of these rules means that if you ask Dropbox to redirect a user back to an HTTP address it will <em>always</em> ask them to confirm their permission. If youâ€™re using HTTPS it will just redirect back if they have already approved the connection in the past. This difference in behaviour is a sensible one, however itâ€™s another example of the development and production environments diverging, which we donâ€™t really want.</p><p>Itâ€™s good practice to have all your production traffic use HTTPS, so we need a lightweight HTTPS proxy which we can stick in front of whichever app server weâ€™re developing against.</p><p>At this point, weâ€™re not too concerned about production performance, and want to retain development conveniences such as live-reloading, so we can just proxy requests directly to our app, in this case a Rails server fired up using <code class=highlighter-rouge>rails s</code>.</p><h3 id=the-setup>The setup</h3><p>You may already have an nginx config which works for you in production, but if not, hereâ€™s a simple setup which proxies all requests to an upstream server/container named â€˜railsâ€™, and redirects all HTTP traffic to HTTPS:</p><noscript><pre>user nobody nogroup;

pid /tmp/nginx.pid;

error_log stderr;
# error_log /var/log/nginx/error.log;

events {
  worker_connections 1024; # increase if you have lots of clients
  accept_mutex off; # &quot;on&quot; if nginx worker_processes &gt; 1
  # use epoll; # enable for Linux 2.6+
  # use kqueue; # enable for FreeBSD, OSX
}

http {
  include mime.types;
  default_type application/octet-stream;
  # access_log /var/log/nginx/access.log combined;
  access_log /dev/stdout;
  sendfile on;
  tcp_nopush on; # off may be better for *some* Comet/long-poll stuff
  tcp_nodelay off; # on may be better for some Comet/long-poll stuff
  gzip on;
  gzip_http_version 1.0;
  gzip_proxied any;
  gzip_min_length 500;
  gzip_disable &quot;MSIE [1-6]\.&quot;;

  # So Rails can be aware of whether it&#39;s HTTP/HTTPS
  proxy_set_header X-Forwarded-Proto $scheme;

  upstream app_server {
    server rails:3000 fail_timeout=0;
  }

  # global certs per ip but a cert can sign *.mysite.dev mysite.dev
  ssl_certificate      /usr/local/app/certs/server.crt;
  ssl_certificate_key  /usr/local/app/certs/server.key;

  server {
    listen         80;
    server_name    192.168.99.100;
    return         301 https://$server_name$request_uri;
  }

  server {
    listen       443 ssl;
    server_name 192.168.99.100;
    ssl           on;
    client_max_body_size 4G;
    keepalive_timeout 5;
    root /usr/src/app/;
    try_files $uri/index.html $uri.html $uri @app;

    location @app {
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://app_server;
    }

    # Rails error pages
    error_page 500 502 503 504 /500.html;
    location = /500.html {
      root /usr/src/app/public;
    }
  }
}
</pre></noscript><script src="https://gist.github.com/spikeheap/488929887d22e74783a5f4f982981a84.js?file=nginx.conf"></script><p>The <a href=TODO>official nginx docker images</a> donâ€™t currently support HTTPS, so weâ€™ll need to build an image to serve as our proxy:</p><noscript><pre>FROM alpine:3.2
MAINTAINER ryan@slatehorse.com

RUN apk add --update nginx openssl &amp;&amp; rm -rf /var/cache/apk/*

COPY ./nginx.conf /etc/nginx/nginx.conf

# Generate certificates
ENV CERTIFICATE_DIR=/usr/local/app/certs

# The hostname used in the certificate. For OSX/Windows you can use the VM IP.
# For Linux, localhost works fine. 
ENV DOCKER_HOSTNAME=192.168.99.100

RUN mkdir -p /usr/local/app/certs

RUN openssl req -new -x509 -nodes -subj &quot;/CN=${DOCKER_HOSTNAME}/O=Your Company Name/C=UK&quot; -keyout $CERTIFICATE_DIR/server.key -out $CERTIFICATE_DIR/server.crt

VOLUME /var/log/nginx/

EXPOSE 80 443

CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]
</pre></noscript><script src="https://gist.github.com/spikeheap/488929887d22e74783a5f4f982981a84.js?file=Dockerfile"></script><p>This isnâ€™t really doing anything interesting other than the following:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code>RUN openssl req <span class=nt>-new</span> <span class=nt>-x509</span> <span class=nt>-nodes</span> <span class=nt>-subj</span> <span class=s2>"/CN=</span><span class=k>${</span><span class=nv>DOCKER_HOSTNAME</span><span class=k>}</span><span class=s2>/O=Your Company Name/C=UK"</span> <span class=nt>-keyout</span> <span class=nv>$CERTIFICATE_DIR</span>/server.key <span class=nt>-out</span> <span class=nv>$CERTIFICATE_DIR</span>/server.crt
</code></pre></div></div><p>This generates a self-signed certificate and drops it into the path weâ€™ve used in <code class=highlighter-rouge>nginx.conf</code>.</p><p>With that, youâ€™re ready to go, in development at least. To integrate this into an existing docker-compose setup you could drop the above files in <code class=highlighter-rouge>./docker/nginx/</code> and add the following to your <code class=highlighter-rouge>docker-compose.yml</code>:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>nginx</span><span class=pi>:</span>
  <span class=na>build</span><span class=pi>:</span> <span class=s>docker/nginx/</span>
  <span class=na>ports</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s2>"</span><span class=s>80:80"</span>
    <span class=pi>-</span> <span class=s2>"</span><span class=s>443:443"</span>
  <span class=na>links</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>rails</span>
</code></pre></div></div><p>Fire up a browser and check it out. The certificate is self-signed, so your browser wonâ€™t trust it by default, but you trust yourselfâ€¦ right?</p><h3 id=caching>Caching</h3><p>With the above approach youâ€™ll get a new self-signed certificate every time you rebuild the image. This can be a bit of a pain if youâ€™re rebuilding often, so if this affects you just mount a a local directory as a volume at<code class=highlighter-rouge>/usr/local/app/certs</code> and put your certificates there. This will persist across container changes and image builds.</p><h3 id=summary>Summary</h3><p>You probably wouldnâ€™t want to use the nginx configuration provided here for production, but hopefully it demonstrates how easily we can add additional services into our development environment to bridge the gap to production one step at a time.</p><hr><div class=discussion><h1>Discuss!</h1><p>Was this post useful? Why not help others find it by sharing on <a href="https://twitter.com/intent/user?screen_name=spikeheap" target=_blank><i class="fa fa-twitter"></i> twitter</a>. While you're there, get in touch and let me know what you think!</p></div><div class=post-nav><a class="hidden-xs btn btn-sm btn-default pull-left half-width-max text-overflow" href="/posts/2016-04-28-docker-speedy-dependencies/"><i class="fa fa-arrow-circle-left"></i> Faster dependencies with Docker</a> <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2016-04-28-docker-speedy-dependencies/"><i class="fa fa-fw fa-arrow-circle-left"></i> Faster dependencies with Docker</a> <span class=clearfix></span></div></div><div class="col-sm-3 border-left"><div class=bio><img src=/images/profile-400px.d912.jpg><h3>Hi, I'm Ryan</h3><p>I care about code, building great teams and the community. I run <a href=https://www.slatehorse.com>Slate Horse</a> but I'm still a full-stack developer. Previously co-organiser of <a href="http://jsoxford.com/">JSOxford</a> and <a href="http://oxrug.org/">OxRUG</a>.</p><hr><h4>Get in touch</h4><div class=contact-icons><a target=_blank href=https://twitter.com/spikeheap><i class="fa fa-2x fa-twitter-square"></i></a> <a target=_blank href=https://github.com/spikeheap><i class="fa fa-2x fa-github-square"></i></a> <a target=_blank href=http://uk.linkedin.com/in/ryanpbrooks><i class="fa fa-2x fa-linkedin-square"></i></a> <a target=_blank href=mailto:ryanbrooksis+info@gmail.com><i class="fa fa-2x fa-envelope-square"></i></a></div></div></div></div></div><footer class="container-fluid footer--bottom"><div class=container><small>&copy; Ryan Brooks. The content of this page is licensed under the Creative Commons Attribution 3.0 License.</small></div></footer><script src=/vendor/node_modules/jquery/dist/jquery.min.js></script><script src=/vendor/node_modules/bootstrap-sass/assets/javascripts/bootstrap.js></script></body></html>
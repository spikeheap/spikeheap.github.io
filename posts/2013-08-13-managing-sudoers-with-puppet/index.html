<!DOCTYPE html><!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]--><!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]--><!--[if gt IE 8]><!--><html class=no-js><!--<![endif]--><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title></title><meta name=description content=""><meta name=viewport content="width=device-width, initial-scale=1"><link rel=alternate type=application/rss+xml title="Ryan Brooks' blog" href=http://ryanbrooks.co.uk/feed.xml><link rel=stylesheet href=/css/style.d6fa.css><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-43110335-1');ga('send','pageview');</script><meta name=google-site-verification content=Ie2d0Oy5dhnMbWcw7qg7PIeq3Wiv9X7GoyyL9pz39Eo></head><body><!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]--><nav class="navbar navbar-default navbar-top"><div class=container><!-- Brand and toggle get grouped for better mobile display --><div class=navbar-header><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#bs-example-navbar-collapse-1><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a class=navbar-brand href="/">Ryan Brooks</a></div><!-- Collect the nav links, forms, and other content for toggling --><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav"><li><a href=/archives.html>Blog archive</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a target=_blank href=https://github.com/spikeheap><i class="fa fa-2x fa-github-square"></i></a></li><li><a target=_blank href=https://twitter.com/spikeheap><i class="fa fa-2x fa-twitter-square"></i></a></li><li><a target=_blank href=http://uk.linkedin.com/in/ryanpbrooks><i class="fa fa-2x fa-linkedin-square"></i></a></li><li><a target=_blank href=mailto:ryanbrooksis+info@gmail.com><i class="fa fa-2x fa-envelope-square"></i></a></li></ul></div><!-- /.navbar-collapse --></div></nav><!-- <div id="header" class="jumbotron">
	<div class="container">
		<h1><a href="/">Ryan Brooks' blog</a></h1>
	</div>
</div> --><div class=container><div class=row><div class=col-xs-12><a href="/posts/2013-08-11-testing-octopress-and-heroku/"><i class="fa fa-arrow-circle-left"></i> prev</a> | <a href="/posts/2013-08-15-rsnapshot-puppet-module/">next <i class="fa fa-arrow-circle-right"></i></a><h1>Managing sudoers with Puppet <small>13 Aug 2013</small></h1><p></p><blockquote>Managing the sudoers file of the puppetmaster with Puppet is like playing with fire while drenched in petrol. If you must do it be really *really* careful!</blockquote><p>Today I re-learned a valuable lesson about the power of Puppet: it can be a force for evil if you forget the little extra things you set up weeks ago. Fortunately it’s easy to reproduce, so try it for yourself! If there’s ever an obvious reason to keep a remote clone of your Puppet configuration, this is it.</p><!--more--><p>Step one is easy. To have a good self-managing Puppet setup you really want your clients to auto-configure themselves. That configuration is going to do sane things like (for example) setting ‘pluginsync’ and ensuring the Puppet client daemon is running, configured to start on boot, etc.</p><p>Step two follows a little while later. The need arises to manage a sudoers file and rather than reinvent the wheel you install the popular <a href=https://forge.puppetlabs.com/saz/sudo><em>sudo</em> package by <em>saz</em></a>.</p><p>This package got a <a href="https://puppetlabs.com/blog/module-of-the-week-sazsudo-manage-sudo-configuration/">great review from PuppetLabs</a> and is easy to configure:</p><pre><code class=language-ruby># Manage sudoers with the module
class { 'sudo': }

# Declare a sudoer with the username 'bill'
sudo::conf { 'bill':
  priority =&gt; 10,
  content  =&gt; 'bill ALL=(ALL) NOPASSWD: ALL',
}
</code></pre><p>The key step here is to run Puppet and see new files created in /etc/sudoers.d/, check the content and think all is well. The <em>facepalm</em> moment really happened when I failed to check the run had added the <em>include</em> into the sudoers file to make it bother to read the files in <em>sudoers.d</em>. Unfortunately for me this hadn’t happened, so although the files were there I no longer had sudo privileges on the client.</p><p>No problem! Simply fixing the module to add the <em>include</em> statement would bring the client back online. Unless step three has been done.</p><p>Step three closes the loop on this suprisingly vicious circle. A few days prior to step two I was refactoring <em>site.pp</em> and decide to move the puppetmaster into the default node group so I could define it using Hiera. The migration was simple (thanks Hiera!) but in my common definition I had included the puppet client package, which caused the puppetmaster to start updating every 30 minutes like every other node.</p><p>I was a couple of minutes too late to prevent the disaster. Locking myself out of the puppetmaster was a little embarrassing, but did give me the opportunity to build the puppetmaster from scratch using Puppet. Oh how a technology can redeem itself.</p><h5 id=rebuilding-the-puppetmaster-from-scratch>Rebuilding the puppetmaster from scratch</h5><p>Building the puppetmaster from only the /etc/puppet configuration is actually suprisingly easy. After pushing a change to the puppet repository which would prevent the problem above from being deployed to the new instance, the full steps to provision a new VM and go from zero to a full installation were:</p><ul><li>Provision the VM and log into it.</li><li><a href=http://apt.puppetlabs.com/README.txt>Add the newest Puppet repositories to APT</a> (my Puppet configuration would do this later, but lets start as we mean to go on).</li><li>Run the usual <code>apt-get install puppet git</code></li><li>Clone the Git repository of the Puppet configuration (the entirety of /etc/puppet).</li><li>Use <em>puppet apply</em> on <em>site.pp</em>. I expected this to fail (and it did raise a couple of errors) but it did a significant enough job to then allow puppetmaster to start and a <em>puppet agent -t</em> to be run. <code>bash puppet apply /etc/puppet/manifests/site.pp</code></li><li>Make a cup of tea and bask in the reflected glory.</li></ul><h5 id=lessons-learned>Lessons learned</h5><p>So the lessons to be learned from this exercise are many and obvious:</p><ol><li>Always keep a remote clone (or backup) of your Puppet configuration.</li><li>Check the puppetmaster’s configuration doubly-trebly carefully, especially for the crux items like sudo where you could be locked out.</li><li>A fully managed Puppet node is trivial to bring up, even if that node is the puppetmaster.</li></ol><p>Although I would rather not have been through an hour of pain learning this lesson, I now have a much stronger confidence in our configuration’s resilience, so there’s always a silver lining.</p><p>Now, break over, back to the Puppet Rsnapshot module…</p><div><a class=twitter-share-button href=https://twitter.com/share data-url="http://ryanbrooks.co.uk/posts/2013-08-13-managing-sudoers-with-puppet/" data-via=spikeheap>Tweet</a> <a class=twitter-follow-button href=https://twitter.com/spikeheap data-show-count=false data-lang=en>Follow @spikeheap</a> <!-- set data-annotation to 'bubble' for count --><div class=g-plus data-action=share data-annotation=none></div></div><a href="/posts/2013-08-11-testing-octopress-and-heroku/"><i class="fa fa-arrow-circle-left"></i> prev</a> | <a href="/posts/2013-08-15-rsnapshot-puppet-module/">next <i class="fa fa-arrow-circle-right"></i></a><div id=disqus_thread></div><!-- Disqus comments --><script type=text/javascript>/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'ryanbrooks'; // required: replace example with your forum shortname
    var disqus_identifier = 'posts-2013-08-13-managing-sudoers-with-puppet';
    var disqus_title = 'Managing sudoers with Puppet';
    var disqus_url = 'http://ryanbrooks.co.uk/posts/2013-08-13-managing-sudoers-with-puppet/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href="/posts/2013-08-11-testing-octopress-and-heroku/"><i class="fa fa-arrow-circle-left"></i> prev</a> | <a href="/posts/2013-08-15-rsnapshot-puppet-module/">next <i class="fa fa-arrow-circle-right"></i></a></div></div></div><footer id=footer class=container-fluid><div class=footer--top><div class=row><div class="col-xs-5 col-sm-4 col-md-3 col-lg-2"><h1>Get in touch</h1><div class=contact-icons><a target=_blank href=https://github.com/spikeheap><i class="fa fa-2x fa-github-square"></i></a> <a target=_blank href=https://twitter.com/spikeheap><i class="fa fa-2x fa-twitter-square"></i></a> <a target=_blank href=http://uk.linkedin.com/in/ryanpbrooks><i class="fa fa-2x fa-linkedin-square"></i></a> <a target=_blank href=mailto:ryanbrooksis+info@gmail.com><i class="fa fa-2x fa-envelope-square"></i></a></div></div><div class="col-xs-7 col-sm-6 col-md-5 col-lg-4"><h1>Hi, I'm Ryan</h1><p>I care about code, process and the community. I'm a freelance CTO and full-stack developer, and co-organiser of <a href="http://jsoxford.com/">JSOxford</a>.</p></div></div></div></footer><!-- <footer class="container-fluid footer--middle">
	<div class="container">
		<div class="row">
			<div class="col-xs-12">
				<h1>Have a look around
    				<span>Home</span>
    				<span>Blog</span>
    				<span>More about me</span>
    				</h1>
			</div>
		</div>
	</div>		
</footer> --><footer class="container-fluid footer--bottom"><div class=container><small>&copy; Ryan Brooks. The content of this page is licensed under the Creative Commons Attribution 3.0 License, and code samples are licensed under the Apache 2.</small></div></footer><script src=/bower_components/jquery/dist/jquery.min.js></script><script src=/bower_components/bootstrap-sass/assets/javascripts/bootstrap.js></script><!-- Twitter bits --><script>window.twttr=(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return;js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);t._e=[];t.ready=function(f){t._e.push(f);};return t;}(document,"script","twitter-wjs"));</script><!-- Google plus --><script src=https://apis.google.com/js/platform.js async defer>{lang: 'en-GB'}</script></body></html>
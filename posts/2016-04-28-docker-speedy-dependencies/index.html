

<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Faster dependencies with Docker</title>
        
          <meta name="description" content="This post explains how to speed up your builds by seeding your Docker image with most of your dependencies, without resorting to data volumes." />
        

        
          <!-- facebook open graph tags -->
          <meta property="og:type" content="article" />
          <meta property="og:site_name" content="Ryan Brooks' blog">
          <meta property="og:url" content="https://www.ryanbrooks.co.uk/posts/2016-04-28-docker-speedy-dependencies/" />
          <meta property="og:title" content="Faster dependencies with Docker" />
          <meta property="og:description" content="This post explains how to speed up your builds by seeding your Docker image with most of your dependencies, without resorting to data volumes." />

          <!-- twitter card tags additive with the og: tags -->
          <meta name="twitter:card" content="summary">
          <meta name="twitter:site" content="@spikeheap" />
          <meta name="twitter:url" value="https://www.ryanbrooks.co.uk/posts/2016-04-28-docker-speedy-dependencies/" />
          <meta name="twitter:title" value="Faster dependencies with Docker" />
          <meta name="twitter:description" value="This post explains how to speed up your builds by seeding your Docker image with most of your dependencies, without resorting to data volumes." />
          <meta name="twitter:label1" value="Reading time" />
          <meta name="twitter:data1" value="ðŸ•’ 7 minutes" />
        
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="alternate" type="application/rss+xml" title="Ryan Brooks' blog" href="https://www.ryanbrooks.co.uk/feed.xml">
        <!-- build:css /css/style.css -->
        <link rel="stylesheet" href="/css/style.css">
        <!-- endbuild -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-43110335-1');ga('send','pageview');
        </script>
        <meta name="google-site-verification" content="Ie2d0Oy5dhnMbWcw7qg7PIeq3Wiv9X7GoyyL9pz39Eo" />
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <nav class="navbar navbar-default navbar-top">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Ryan Brooks</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        
        
          
            <li><a href="/archives/">Blog archive</a></li>
          
        
      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a class="nav-fa-link target="_blank" href="https://github.com/spikeheap"><i class="fa fa-2x fa-github-square"></i></a></li>
    		<li><a class="nav-fa-link target="_blank" href="https://twitter.com/spikeheap"><i class="fa fa-2x fa-twitter-square"></i></a></li>
    		<li><a class="nav-fa-link target="_blank" href="http://uk.linkedin.com/in/ryanpbrooks"><i class="fa fa-2x fa-linkedin-square"></i></a></li>
    		<li><a class="nav-fa-link target="_blank" href="mailto:ryanbrooksis+info@gmail.com"><i class="fa fa-2x fa-envelope-square"></i></a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div>
</nav>


        <div class="container">
  <div class="row">
      <div class="col-sm-9">
          <h1 class="page-title">Faster dependencies with Docker</h1>
          <span class="text-muted">28 Apr 2016</span>, <span class="reading-time text-muted">6 minute read</span>
          <p></p>
          <p>Docker is great for building portable applications, modelling complex environments locally, and helping us bridge the gap between development and production, but installing your Bundler, Bower, NPM, Maven (and so on) dependencies can make builds slow. This post explains how to speed up your builds by seeding the image with most of your dependencies, so subsequent builds arenâ€™t hampered by the â€˜all-or-nothingâ€™ approach to updating dependencies.</p>

<!-- more -->

<h3 id="a-quick-note-on-terms">A quick note on terms</h3>

<p>This post talks about a <code class="language-plaintext highlighter-rouge">Gemfile</code> and Rubyâ€™s gems, but this post applies equally to libraries and dependencies in pretty much any other language. If youâ€™re not familiar, the <code class="language-plaintext highlighter-rouge">Gemfile</code> is the list of libraries, frameworks, and other 3rd party dependencies.</p>

<h3 id="rebuilding-gemsnpm-from-scratch-is-slow">Rebuilding gems/NPM from scratch is slow</h3>

<p>Docker images should contain all of the dependencies required to run your application. If we can guarantee that all our Bundler, NPM and Bower dependencies are already built into the image, we no longer need to worry about outages of <code class="language-plaintext highlighter-rouge">rubygems.org</code> or <code class="language-plaintext highlighter-rouge">github.com</code>. No contention there, right? However, building your dependencies into the Docker image comes at a cost: every time your dependency installation step happens thereâ€™s a good chance youâ€™re blowing away every dependency you downloaded in the last build.</p>

<p>The <a href="https://robots.thoughtbot.com/rails-on-docker">Thoughtbot Rails on Docker post</a> demonstrates how to only bundle your gems when your <code class="language-plaintext highlighter-rouge">Gemfile</code> changes, which at least means your dependencies arenâ€™t re-downloaded every time the code changes. If your dependencies change regularly youâ€™re still a bit stuck. Every time you add, remove or update a gem, the cache is invalidated and the <code class="language-plaintext highlighter-rouge">bundle install</code> step runs again, downloading every gem from scratch.</p>

<p><a href="http://bradgessler.com/articles/docker-bundler/">Brad Gessler built on that approach</a> to leverage data volumes as a cross-container gem store. By updating the dependencies in a container you no longer need to re-build your image each time, which speeds up your development cycle immensely. This comes at a cost: by using volumes weâ€™re maintaining state for the container which may not be obvious later on. This <em>may</em> be fine, after all we donâ€™t rebuild the image every time we change the code. However if weâ€™re pushing towards immutable infrastructure itâ€™s reasonable to treat your gems in the same way as your OS and system dependencies. This approach also allows our environments to diverge, so a piece of code canâ€™t be expected to behave the same way for the same container if we run it on different machines with different sets of gems installed.</p>

<p>The intention is solid, so how can we apply the same principles to the image build process instead?</p>

<h2 id="a-new-solution-cache-dependencies-from-a-point-in-the-past">A new solution: cache dependencies from a point in the past</h2>

<p>We can work around Dockerâ€™s behaviour of invalidating the cache on any change to the dependencies list by seeding our image with dependencies from a static point in time. Once we have the majority of our dependencies cached, subsequent <code class="language-plaintext highlighter-rouge">bundle install</code>s will only need to grab the newer gems.</p>

<p>Weâ€™ll start with an example and then pick it apart:</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> APP=/usr/src/app</span>
<span class="k">RUN </span><span class="nb">mkdir</span> <span class="nv">$APP</span>
<span class="k">WORKDIR</span><span class="s"> $APP</span>

<span class="c"># [1]</span>
<span class="k">ADD</span><span class="s"> https://raw.githubusercontent.com/user/repository/master/Gemfile .</span>
<span class="k">ADD</span><span class="s"> https://raw.githubusercontent.com/user/repository/master/Gemfile.lock .</span>
<span class="k">RUN </span>bundle <span class="nb">install</span>

<span class="c"># [2]</span>
<span class="k">ADD</span><span class="s"> Gemfile .</span>
<span class="k">ADD</span><span class="s"> Gemfile.lock .</span>
<span class="k">RUN </span>bundle <span class="nb">install</span>

<span class="c"># [3]</span>
<span class="k">ADD</span><span class="s"> . $APP</span>
</code></pre></div></div>

<p>What weâ€™re doing here is fairly straightforward:</p>

<ol>
  <li>Install your dependencies from a source which changes infrequently. Here weâ€™ve used the master branch of our repository, but you could use a tag or static commit and update it when your build takes too long.</li>
  <li>Install any dependencies we didnâ€™t get in [1]. This will just be new dependencies added in your current branch.</li>
  <li>Add our source code (and do the rest of the build).</li>
</ol>

<p>By grabbing our Gemfile from the <code class="language-plaintext highlighter-rouge">master</code> branch we get most of our dependencies up-front. The subsequent <code class="language-plaintext highlighter-rouge">bundle install</code> [2] then only needs to download dependencies that have been added as part of the feature branch. This means we can add and remove dependencies without fearing Docker invalidating the cache and downloading everything from scratch. Note that [2] and [3] are the popular approach to caching youâ€™re probably already using, so all you need to do is add [1].</p>

<p>Suddenly Docker on rubbish hotel wifi is fun again!</p>

<h3 id="an-aside-this-isnt-all-about-ruby">An aside: this isnâ€™t all about Ruby!</h3>

<p>This approach isnâ€™t Ruby specific, so you can speed up your NPM dependencies too:</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ADD</span><span class="s"> https://raw.githubusercontent.com/user/repository/master/package.json .</span>
<span class="k">RUN </span>npm <span class="nb">install</span>

<span class="k">ADD</span><span class="s"> package.json .</span>
<span class="k">RUN </span>npm <span class="nb">install</span>
</code></pre></div></div>

<p>Or your bower dependencies:</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ADD</span><span class="s"> https://raw.githubusercontent.com/user/repository/master/bower.json .</span>
<span class="k">RUN </span>bower <span class="nb">install</span>

<span class="k">ADD</span><span class="s"> bower.json .</span>
<span class="k">RUN </span>bower <span class="nb">install</span>
</code></pre></div></div>

<p>You get the idea!</p>

<h3 id="picking-a-seed-point">Picking a seed point</h3>

<p>The point you cache in step [1] can make all the difference to your build times, particularly if your dependencies change regularly. Weâ€™ve chosen to minimise manual intervention by using the <code class="language-plaintext highlighter-rouge">master</code> branch, ensuring the cache point will follow our deployed code closely. Itâ€™s also completely reasonable to use <code class="language-plaintext highlighter-rouge">develop</code> if you have a slower release cadence.</p>

<h3 id="getting-the-historical-dependency-list">Getting the historical dependency list</h3>

<p>In the above examples, we have just referenced a public GitHub repository, but chances are youâ€™re working with private repositories or outside of GitHub. Fear not, weâ€™ve got you covered.</p>

<h4 id="private-github-repostories">Private GitHub repostories</h4>

<p><b>Update (2016-07-27):</b> <em>It turns out that the tokens described below expire after an arbitrary amount of time, so this approach will break regularly. Stay tuned for a stable approach, using the GitHub API.</em></p>

<p><del>If youâ€™re using GitHub private repositories youâ€™re in luck: they generate per-file keys to allow you to access a file using a simple URL, e.g.:</del></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://raw.githubusercontent.com/spikeheap/spikeheap.github.io/13b4a64d90fece1889c6c24e8f736a2241fefc6c/README.md?token=AAcWYgmWJyDeDs_6aO-UemuC7ywONtd2ks5XKakOwA%3D%3D
</code></pre></div></div>

<p><del>You can get the token for your files by viewing the file on GitHub and clicking â€˜Rawâ€™ before copying the URL from your address bar. </del></p>

<p><del>Note that the tokens are <strong>per commit reference</strong>, so you should use commit-specific URLs in preference to branch references. The following link will break and return <code class="language-plaintext highlighter-rouge">404</code> as soon as <code class="language-plaintext highlighter-rouge">develop</code> is updated:</del></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://raw.githubusercontent.com/spikeheap/spikeheap.github.io/develop/README.md?token=AAcWYgmWJyDeDs_6aO-UemuC7ywONtd2ks5XKakOwA%3D%3D
</code></pre></div></div>

<h4 id="private-repositories-on-bitbucket-gitlab-etc">Private repositories on BitBucket, GitLab, etc.</h4>

<p>Most other services provide token-based access to raw files, and an exercise for the reader to work out their intricacies. <a href="http://stackoverflow.com/a/34499948/384693">This StackOverflow answer</a> demonstrates it working for BitBucket.</p>

<p>Be sure to consider where your keys/tokens may be exposed. The GitHub example uses tokens specific to each file/revision pair, so the cost of an exposed key is quite small. If youâ€™re exposing your private API key which gives write-access to your repository, things are a little different ðŸ˜±ðŸ˜¨ðŸ˜°.</p>

<h4 id="fallback">Fallback</h4>

<p>If youâ€™re using something completely esoteric, you can use Dockerâ€™s <code class="language-plaintext highlighter-rouge">RUN</code> command in preference to <code class="language-plaintext highlighter-rouge">ADD</code>ing them as we have above. Through <code class="language-plaintext highlighter-rouge">RUN</code> you can curl your files down, install a custom client, or whatever you need.</p>

<h2 id="summary--tldr">Summary / TL;DR</h2>

<p>Using the above approach we get the benefits of cached dependencies with the benefits of quick builds and deployable artefacts.</p>

<p>Deployments are hard. Striking a balance between stable production builds, fast development cycles and keeping development and production as close as possible is even harder.</p>

<ol>
  <li>Speed up your Docker image build time by using a version of your dependencies list which changes less frequently to leverage Dockers caching mechanism.</li>
  <li>One good source for the more-stable dependencies list is your GitHub repository.</li>
  <li>Be careful not to expose your keys and secrets.</li>
  <li>Only do this if image build time is impacting some part of your life!</li>
</ol>


          <hr>

          <div class="discussion">
<h1>Discuss!</h1>
<p>
  Was this post useful? Why not help others find it by sharing on <a href="https://twitter.com/intent/user?screen_name=spikeheap" target="_blank"><i class="fa fa-twitter"></i> twitter</a>. While you're there, get in touch and let me know what you think!
</p>
</div>

          <div class="post-nav">

    <a class="hidden-xs btn btn-sm btn-default pull-left half-width-max text-overflow" href="/posts/2015-09-05-imagemagick-circular-avatars/"><i class="fa fa-arrow-circle-left"></i> Migrating user avatars to circular crops, with ImageMagick</a>
    <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2015-09-05-imagemagick-circular-avatars/"><i class="fa fa-fw fa-arrow-circle-left"></i> Migrating user avatars to circular crops, with ImageMagick</a>




    <a class="btn btn-sm btn-default hidden-xs pull-right half-width-max text-overflow" href="/posts/2016-05-19-nginx-docker-proxy/">A simple HTTPS proxy with Nginx on Docker <i class="fa fa-arrow-circle-right"></i></a>
    <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2016-05-19-nginx-docker-proxy/"><i class="fa fa-fw fa-arrow-circle-right"></i> A simple HTTPS proxy with Nginx on Docker</a>

<span class="clearfix">
</span>
</div>



      </div>
      <div class="col-sm-3 border-left">
        <div class="bio">
  <img src="/images/profile-400px.jpg">
  <h3>Hi, I'm Ryan</h3>
  <p>
      I care about code, building great teams and the community. I run <a href="https://www.slatehorse.com">Slate Horse</a> but I'm still a full-stack developer. Previously co-organiser of <a href="http://jsoxford.com/">JSOxford</a> and <a href="http://oxrug.org/">OxRUG</a>.
  </p>

  <hr>

  <h4>Get in touch</h4>

  <div class="contact-icons">
	<a target="_blank" href="https://twitter.com/spikeheap"><i class="fa fa-2x fa-twitter-square"></i></a>
  <a target="_blank" href="https://github.com/spikeheap"><i class="fa fa-2x fa-github-square"></i></a>
	<a target="_blank" href="http://uk.linkedin.com/in/ryanpbrooks"><i class="fa fa-2x fa-linkedin-square"></i></a>
	<a target="_blank" href="mailto:ryanbrooksis+info@gmail.com"><i class="fa fa-2x fa-envelope-square"></i></a>
</div>

</div>

      </div>
  </div>
</div>


        <footer class="container-fluid footer--bottom">
	<div class="container">
		<small>
			&copy; Ryan Brooks. The content of this page is licensed under the Creative Commons Attribution 3.0 License.
		</small>
	</div>
</footer>


        <script src="/vendor/node_modules/jquery/dist/jquery.min.js"></script>
        <script src="/vendor/node_modules/bootstrap-sass/assets/javascripts/bootstrap.js"></script>
    </body>
</html>

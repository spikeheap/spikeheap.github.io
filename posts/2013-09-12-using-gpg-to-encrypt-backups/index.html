<!DOCTYPE html><!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]--><!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]--><!--[if gt IE 8]><!--><html class=no-js><!--<![endif]--><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title></title><meta name=description content=""><meta name=viewport content="width=device-width, initial-scale=1"><link rel=alternate type=application/rss+xml title="Ryan Brooks' blog" href=http://ryanbrooks.co.uk/feed.xml><link rel=stylesheet href=/css/style.9e93.css><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-43110335-1');ga('send','pageview');</script><meta name=google-site-verification content=Ie2d0Oy5dhnMbWcw7qg7PIeq3Wiv9X7GoyyL9pz39Eo></head><body><!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]--><nav class="navbar navbar-default navbar-top"><div class=container><!-- Brand and toggle get grouped for better mobile display --><div class=navbar-header><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#bs-example-navbar-collapse-1><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a class=navbar-brand href="/">Ryan Brooks</a></div><!-- Collect the nav links, forms, and other content for toggling --><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav"><li><a href=/archives.html>Blog archive</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a target=_blank href=https://github.com/spikeheap><i class="fa fa-2x fa-github-square"></i></a></li><li><a target=_blank href=https://twitter.com/spikeheap><i class="fa fa-2x fa-twitter-square"></i></a></li><li><a target=_blank href=http://uk.linkedin.com/in/ryanpbrooks><i class="fa fa-2x fa-linkedin-square"></i></a></li><li><a target=_blank href=mailto:ryanbrooksis+info@gmail.com><i class="fa fa-2x fa-envelope-square"></i></a></li></ul></div><!-- /.navbar-collapse --></div></nav><!-- <div id="header" class="jumbotron">
	<div class="container">
		<h1><a href="/">Ryan Brooks' blog</a></h1>
	</div>
</div> --><div class=container><div class=row><div class=col-xs-12><a href="/posts/2013-08-24-ive-moved/"><i class="fa fa-arrow-circle-left"></i> prev</a> | <a href="/posts/2013-10-02-puppet-talk/">next <i class="fa fa-arrow-circle-right"></i></a><h1>Using GPG to encrypt backups <small>12 Sep 2013</small></h1><p></p><p>If you’re doing off-site backups (and if you’re not, you should), you’ve probably wondered how much you trust the place you’re uploading to. Fortunately <a href=http://en.wikipedia.org/wiki/Public-key_cryptography>public-key cryptography</a> is here to help.</p><p>With public-key encryption, you have two keys, a <em>public</em> key and a <em>private</em> key. The public key can be passed around to anyone you like, published on the Internet, etc. The private key is (unsurprisingly) kept secret. The keys are generated as pairs and are intrinsically linked, so you can do the following:</p><ol><li>Someone encrypts a message or file using your <em>public</em> key. Only the <em>private</em> key can decrypt it (which only you have).</li><li>You sign a message or file using your <em>private</em> key. Anyone with your <em>public</em> key can verify that the message was written by you and hasn’t been altered.</li></ol><p>This is commonly used for e-mail, and has a great advantage when you’re using it to encrypt files for off-site backup because the private key is always kept private. If you have many servers they all use the same public key to encrypt their data before uploading to a remote site. The data on that site is encrypted, so an attacker would need your private key to access it. But what about if one of the servers is compromised? Obviously the attacker has access to the live data on that server, but the <em>public</em> key stored on the machine doesn’t allow decryption, so they are no closer to accessing data anywhere else. This means you don’t have to worry about revoking keys or having independent keys for each machine.</p><p><a href=http://www.gnupg.org>Gnu Privacy Guard</a> (GPG) is an open-source tool for encrypting and signing data using public-key cryptography. It’s easy to install, and is included on most modern operating systems. There are also several nice front-ends, for example <a href="https://gpgtools.org/">GPGTools for OSX</a>, which take away the effort of having to use the terminal.</p><p>You can generate a key using the following command. Note that a passphrase is a <em>really</em> good idea because it gives you that little bit of extra protection: if you lose your private key it’s useless without the passphrase. The passphrase is only needed for the private key, so a script can still encrypt the data without human interaction.</p><pre><code class=language-bash>gpg --gen-key
</code></pre><p>Once you’ve generated your key you can send it to a key server so your other hosts can get at it (XXXXXXXX needs to be replaced with the short ID for your key):</p><pre><code class=language-bash>gpg --keyserver subkeys.pgp.net --send-key XXXXXXXX
</code></pre><p>Then it’s a really good idea to take a backup of your key (you can also copy your ~/.gnupg directory somewhere safe):</p><pre><code class=language-bash>gpg --export-secret-keys --armor john@example.com &gt; john-privkey.asc
</code></pre><p>Make sure to keep the resultant file safe, if you lose your private key <em>or</em> forget your passphrase then the contents of any encrypted files are lost forever.</p><p>On your remote servers the commands you need to download the public key and set it to be trusted:</p><pre><code class=language-bash>gpg --keyserver subkeys.pgp.net --recv-keys XXXXXXXX
gpg --edit XXXXXXX trust # set 5 if you trust it ultimately, and confirm
</code></pre><p>Then you can encrypt a file:</p><pre><code class=language-bash>gpg --encrypt --recipient XXXXXXXX FILENAME
</code></pre><p>The result is a new file: FILENAME.gpg. Try decrypting it (gpg –decrypt FILENAME). On the remote machine you should see:</p><pre><code class=language-bash>gpg: decryption failed: secret key not available
</code></pre><p>But on the machine you created the keys on it will ask you for your passphrase and voila!</p><h2 id=signatures>Signatures</h2><p>This post hasn’t touched on signatures or non-repudiation. Although the above will give you a set of encrypted files, you can’t be sure that it was you who encrypted it, after all, your public key is available to anyone. GPG allows messages to be signed, which proves a message or file hasn’t been altered since the owner of that key signed it.</p><p>For multi-server backups, each server should have its own key pair for signing which <em>is not</em> the same as the encryption key. That way if a server is compromised you don’t need to worry about the integrity of files sent by the other servers.</p><div><a class=twitter-share-button href=https://twitter.com/share data-url="http://ryanbrooks.co.uk/posts/2013-09-12-using-gpg-to-encrypt-backups/" data-via=spikeheap>Tweet</a> <a class=twitter-follow-button href=https://twitter.com/spikeheap data-show-count=false data-lang=en>Follow @spikeheap</a> <!-- set data-annotation to 'bubble' for count --><div class=g-plus data-action=share data-annotation=none></div></div><a href="/posts/2013-08-24-ive-moved/"><i class="fa fa-arrow-circle-left"></i> prev</a> | <a href="/posts/2013-10-02-puppet-talk/">next <i class="fa fa-arrow-circle-right"></i></a><div id=disqus_thread></div><!-- Disqus comments --><script type=text/javascript>/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'ryanbrooks'; // required: replace example with your forum shortname
    var disqus_identifier = 'posts-2013-09-12-using-gpg-to-encrypt-backups';
    var disqus_title = 'Using GPG to encrypt backups';
    var disqus_url = 'http://ryanbrooks.co.uk/posts/2013-09-12-using-gpg-to-encrypt-backups/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href="/posts/2013-08-24-ive-moved/"><i class="fa fa-arrow-circle-left"></i> prev</a> | <a href="/posts/2013-10-02-puppet-talk/">next <i class="fa fa-arrow-circle-right"></i></a></div></div></div><footer id=footer class=container-fluid><div class=footer--top><div class=row><div class="col-xs-5 col-sm-4 col-md-3 col-lg-2"><h1>Get in touch</h1><div class=contact-icons><a target=_blank href=https://github.com/spikeheap><i class="fa fa-2x fa-github-square"></i></a> <a target=_blank href=https://twitter.com/spikeheap><i class="fa fa-2x fa-twitter-square"></i></a> <a target=_blank href=http://uk.linkedin.com/in/ryanpbrooks><i class="fa fa-2x fa-linkedin-square"></i></a> <a target=_blank href=mailto:ryanbrooksis+info@gmail.com><i class="fa fa-2x fa-envelope-square"></i></a></div></div><div class="col-xs-7 col-sm-6 col-md-5 col-lg-4"><h1>Hi, I'm Ryan</h1><p>I care about code, process and the community. I'm a freelance CTO and full-stack developer, and co-organiser of <a href="http://jsoxford.com/">JSOxford</a>.</p></div></div></div></footer><!-- <footer class="container-fluid footer--middle">
	<div class="container">
		<div class="row">
			<div class="col-xs-12">
				<h1>Have a look around
    				<span>Home</span>
    				<span>Blog</span>
    				<span>More about me</span>
    				</h1>
			</div>
		</div>
	</div>		
</footer> --><footer class="container-fluid footer--bottom"><div class=container><small>&copy; Ryan Brooks. The content of this page is licensed under the Creative Commons Attribution 3.0 License, and code samples are licensed under the Apache 2.</small></div></footer><script src=/bower_components/jquery/dist/jquery.min.js></script><script src=/bower_components/bootstrap-sass/assets/javascripts/bootstrap.js></script><!-- Twitter bits --><script>window.twttr=(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return;js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);t._e=[];t.ready=function(f){t._e.push(f);};return t;}(document,"script","twitter-wjs"));</script><!-- Google plus --><script src=https://apis.google.com/js/platform.js async defer>{lang: 'en-GB'}</script></body></html>
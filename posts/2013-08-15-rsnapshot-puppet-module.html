<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-GB" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Rsnapshot Puppet module - Ryan Brooks’ blog</title>
<meta name="description" content="Over the past couple of weeks I’ve been building a full-fledged Rsnapshot module for Puppet. What started as a simple puppet-isation of an install turned into a labour of love to build my first publishable Puppet module.">


  <meta name="author" content="Ryan Brooks">
  
  <meta property="article:author" content="Ryan Brooks">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_GB">
<meta property="og:site_name" content="Ryan Brooks' blog">
<meta property="og:title" content="Rsnapshot Puppet module">
<meta property="og:url" content="https://www.ryanbrooks.co.uk/posts/2013-08-15-rsnapshot-puppet-module.html">


  <meta property="og:description" content="Over the past couple of weeks I’ve been building a full-fledged Rsnapshot module for Puppet. What started as a simple puppet-isation of an install turned into a labour of love to build my first publishable Puppet module.">







  <meta property="article:published_time" content="2013-08-15T19:20:00+00:00">






<link rel="canonical" href="https://www.ryanbrooks.co.uk/posts/2013-08-15-rsnapshot-puppet-module.html">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Ryan Brooks' blog Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Ryan Brooks' blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/prev"
                
                
              >Previously</a>
            </li><li class="masthead__menu-item">
              <a
                href="/now"
                
                
              >Now</a>
            </li><li class="masthead__menu-item">
              <a
                href="/posts-by-year/"
                
                
              >Posts</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://www.ryanbrooks.co.uk/">
        <img src="/images/ryan_brooks_peak_autumn_2020.jpg" alt="Ryan Brooks" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://www.ryanbrooks.co.uk/" itemprop="url">Ryan Brooks</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>CTO with a dev &amp; ops origin story. Camembert lover/buzzword hater. Ex JSOxford, OxRUG, MoJ, GDS. Only personal opinions here</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Sheffield, UK</span>
        </li>
      

      
        
          
        
          
            <li><a href="https://ruby.social/@spikeheap" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i><span class="label">Mastodon</span></a></li>
          
        
          
            <li><a href="https://github.com/spikeheap" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Rsnapshot Puppet module">
    <meta itemprop="description" content="People want to be seen as being clever, so the result is people wind up working in a cave.Brian Fitzpatrick, Ben Collins-Sussman http://www.youtube.com/watch?v=0SARbwvhupQ">
    <meta itemprop="datePublished" content="2013-08-15T19:20:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://www.ryanbrooks.co.uk/posts/2013-08-15-rsnapshot-puppet-module.html" itemprop="url">Rsnapshot Puppet module
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <blockquote>
People want to be seen as being clever, so the result is people wind up working in a cave.
<small>Brian Fitzpatrick, Ben Collins-Sussman <cite>http://www.youtube.com/watch?v=0SARbwvhupQ</cite></small>
</blockquote>

<p>I’m often a perfectionist, and after watching <a href="http://www.youtube.com/watch?v=0SARbwvhupQ">this excellent talk at Google I/O 2009</a> have realised I’m definitely guilty of keeping things under wraps until they’re ‘ready’ (read ‘dead and forgotten’). Here’s my attempt to rectify that.</p>

<p>Over the past couple of weeks I’ve been building a full-fledged <a href="http://www.rsnapshot.org/">Rsnapshot</a> module for the <a href="http://projects.puppetlabs.com/">Puppet configuration management platform</a>. What started as a simple puppet-isation of an install turned into a labour of love to build my first publishable Puppet module.</p>

<p>The module can be found here: https://github.com/spikeheap/puppet_rsnapshot and is released under the <a href="http://www.gnu.org/licenses/gpl.html">GPL v3</a>. Pull requests and issues are welcome!</p>

<p>The module solves a simple problem: configure a central Rsnapshot system with node-specific backup directories. The module is completely hiera-compatible.</p>

<p>Declaring an Rsnapshot server is as simple as:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">{</span><span class="s1">'backup.example.com'</span><span class="p">:</span>
  <span class="n">rsnapshot</span><span class="p">{</span><span class="s1">'backup'</span><span class="p">:</span>
    <span class="n">sync_first</span>      <span class="o">=&gt;</span> <span class="kp">true</span>
		<span class="n">ssh_private_key</span> <span class="o">=&gt;</span> <span class="no">YOURSSHKEY</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then declare a client as follows:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">{</span><span class="s1">'cleverthing.example.com'</span><span class="p">:</span>
  <span class="n">rsnapshot</span><span class="o">::</span><span class="n">client</span><span class="p">{</span><span class="s1">'cleverthing'</span><span class="p">:</span>
    <span class="n">dirs</span> <span class="o">=&gt;</span> <span class="p">[</span>
		  <span class="s1">'/usr/local/myamazingapp/'</span><span class="p">,</span>
		  <span class="s1">'/var/'</span>
		<span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It’s even simpler if you’re using Hiera, where you’d declare the server as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">classes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">rsnapshot</span>

<span class="s">rsnapshot::ssh_private_key: |</span>
  <span class="s">-----BEGIN RSA PRIVATE KEY-----</span>
  <span class="s">...</span>
  <span class="s">-----END RSA PRIVATE KEY-----</span>

<span class="c1"># All the following variables are optional, and are just to illustrate configuration </span>
<span class="s">rsnapshot::sync_first: </span><span class="no">true</span>
<span class="s">rsnapshot::interval_hourly: </span><span class="m">24</span>
<span class="s">rsnapshot::cron_sync_hour: '*'</span>
<span class="s">rsnapshot::cron_sync_minute: </span><span class="m">0</span>
<span class="s">rsnapshot::cron_hourly_hour: '*'</span>
<span class="s">rsnapshot::cron_hourly_minute: </span><span class="m">30</span>
<span class="s">rsnapshot::cron_daily_hour: </span><span class="m">23</span>
<span class="s">rsnapshot::cron_daily_minute: </span><span class="m">0</span>
<span class="s">rsnapshot::cron_weekly_hour: </span><span class="m">22</span>
<span class="s">rsnapshot::cron_weekly_minute: </span><span class="m">0</span>
<span class="s">rsnapshot::cron_monthly_hour: </span><span class="m">21</span>
<span class="s">rsnapshot::cron_monthly_minute: </span><span class="m">0</span>
<span class="s">rsnapshot::snapshot_root: /backups/rsnapshot/</span>
</code></pre></div></div>

<p>and the client:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">classes</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">rsnapshot::client</span>

<span class="s">rsnapshot::client::dirs: [</span>
<span class="s1">'</span><span class="s">/usr/local/myamazingapp/'</span><span class="err">,</span>
<span class="s1">'</span><span class="s">/var/'</span>
<span class="err">]</span>
</code></pre></div></div>

<p>The module has support for all the configuration options of Rsnapshot, and I’ll update the documentation shortly to explain the additional parameters.</p>

<h3 id="limitations">Limitations</h3>

<p>Currently the module doesn’t have any tests, so use it at your peril and test it on a staging environment first. This has also been developed entirely on an Ubuntu platform so your mileage may vary on other systems, though there’s no reason it won’t work with the right paths passed to it.</p>

<p>I haven’t published the module to the <a href="https://forge.puppetlabs.com/">Puppet Forge</a> yet because I want to complete a suite of tests, check it with puppet-lint and get the documentation up to scratch first.</p>

<p>In addition, the following features aren’t yet complete:</p>

<ul>
  <li>Read-only NFS mount of the backup for recovery</li>
  <li>Node-defined exclusions (I’m not sure if this is possible with Rsnapshot)</li>
  <li>Read-only rsync server accessed over SSH. A best-practice setup using restricted SSH access to a read-only rsync daemon to reduce the possibilty of attack through the backup system.</li>
  <li>Report collection</li>
  <li>Per-host pre-backup scripts</li>
  <li>Space checking prior to backup</li>
</ul>

<p>This is my first foray into Puppet modules, so feedback and (gentle) criticism is invited so I can learn. That link again is https://github.com/spikeheap/puppet_rsnapshot .</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#engineering" class="page__taxonomy-item p-category" rel="tag">engineering</a><span class="sep">, </span>
    
      <a href="/tags/#guide" class="page__taxonomy-item p-category" rel="tag">guide</a>
    
    </span>
  </p>




        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2013-08-15T19:20:00+00:00">August 15, 2013</time></p>

      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Rsnapshot+Puppet+module%20https%3A%2F%2Fwww.ryanbrooks.co.uk%2Fposts%2F2013-08-15-rsnapshot-puppet-module.html"
    class="btn btn--twitter"
    onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
    title="Share on Twitter"><i
      class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.ryanbrooks.co.uk%2Fposts%2F2013-08-15-rsnapshot-puppet-module.html"
    class="btn btn--linkedin"
    onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
    title="Share on LinkedIn"><i
      class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>

      
  <nav class="pagination">
    
      <a href="/posts/2013-08-13-managing-sudoers-with-puppet.html" class="pagination--pager" title="Managing sudoers with Puppet
">Previous</a>
    
    
      <a href="/posts/2013-08-16-refactoring-directory-into-git-submodule.html" class="pagination--pager" title="Refactoring a directory into a git submodule
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You May Also Enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2023-06-12-protect-yourself-first.html" rel="permalink">Protect yourself first
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">A common refrain in software engineering is to put your team before yourself. Also, put the customer first. Make sure you align with the organisation’s goals...</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2023-02-17-linting-branch-changes.html" rel="permalink">Incrementally linting a codebase with branch changes
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Update 26th February 2023: replaced xargs approach because it interfered with Pry local debugging.

</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2023-01-17-capybara-webmock-allow-http.html" rel="permalink">Capybara, WebMock, and too many open files
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Getting set up with a new codebase is always a fun, sometimes head-scratching experience where you have to discern whether the issues you’re facing are becau...</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/posts/2023-01-16-docker-contexts.html" rel="permalink">Docker context switching
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Sometimes it’s useful to run multiple Docker contexts/daemons, e.g. if you’re running Docker Desktop and Lima, or local Kubernetes clusters.

</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://ruby.social/@spikeheap" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i> Mastodon</a></li>
        
      
        
          <li><a href="https://github.com/spikeheap" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 <a href="https://www.ryanbrooks.co.uk">Ryan Brooks' blog</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZVSM9FVFJ3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZVSM9FVFJ3', { 'anonymize_ip': true});
</script>








  </body>
</html>

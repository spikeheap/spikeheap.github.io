<!DOCTYPE html><!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]--><!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]--><!--[if gt IE 8]><!--><html class=no-js><!--<![endif]--><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Refactoring a directory into a git submodule</title><!-- facebook open graph tags --><meta property=og:type content=article><meta property=og:site_name content="Ryan Brooks' blog"><meta property=og:url content="https://www.ryanbrooks.co.uk/posts/2013-08-16-refactoring-directory-into-git-submodule/"><meta property=og:title content="Refactoring a directory into a git submodule"><meta property=og:description content=""><!-- twitter card tags additive with the og: tags --><meta name=twitter:card content=summary><meta name=twitter:site content=@spikeheap><meta name=twitter:url value="https://www.ryanbrooks.co.uk/posts/2013-08-16-refactoring-directory-into-git-submodule/"><meta name=twitter:title value="Refactoring a directory into a git submodule"><meta name=twitter:description value=""><meta name=twitter:label1 value="Reading time"><meta name=twitter:data1 value="ðŸ•’ 2 minutes"><meta name=viewport content="width=device-width, initial-scale=1"><link rel=alternate type=application/rss+xml title="Ryan Brooks' blog" href=https://www.ryanbrooks.co.uk/feed.xml><link rel=stylesheet href=/css/style.d41d.css><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-43110335-1');ga('send','pageview');</script><meta name=google-site-verification content=Ie2d0Oy5dhnMbWcw7qg7PIeq3Wiv9X7GoyyL9pz39Eo></head><body><!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]--><nav class="navbar navbar-default navbar-top"><div class=container><!-- Brand and toggle get grouped for better mobile display --><div class=navbar-header><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#bs-example-navbar-collapse-1><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a class=navbar-brand href="/">Ryan Brooks</a></div><!-- Collect the nav links, forms, and other content for toggling --><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav"><li><a href="/archives/">Blog archive</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a class="nav-fa-link target=" _blank="" href=https://github.com/spikeheap><i class="fa fa-2x fa-github-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=https://twitter.com/spikeheap><i class="fa fa-2x fa-twitter-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=http://uk.linkedin.com/in/ryanpbrooks><i class="fa fa-2x fa-linkedin-square"></i></a></li><li><a class="nav-fa-link target=" _blank="" href=mailto:ryanbrooksis+info@gmail.com><i class="fa fa-2x fa-envelope-square"></i></a></li></ul></div><!-- /.navbar-collapse --></div></nav><div class=container><div class=row><div class=col-sm-9><h1 class=page-title>Refactoring a directory into a git submodule</h1><span class=text-muted>16 Aug 2013</span>, <span class="reading-time text-muted">1 minute read</span><p></p><p>To release the Rsnapshot Puppet module I needed to extract the module directory from our entire Puppet configuration Git repository (we know itâ€™s wrong, but itâ€™s how we started and are moving away from it slowly). Fortunately Git has some great functionality (hint: itâ€™s submodules) to allow the directory to be pulled out into a new repository, keeping the commit history.</p><p>The steps I wanted to achieve were:</p><ol><li>Create a new repository containing only the Rsnapshot directory (and the commit history for that directory).</li><li>Remove the directory from the Puppet repository and replace it with a pointer to the Rsnapshot repository.</li></ol><p><a href=http://git-scm.com/book/en/Git-Tools-Submodules>Git submodules</a> solve this use-case. A submodule is treated as a separate repository, but resides within the parent repositoryâ€™s directory structure.</p><!-- more --><p>The simplest way to filter the repository is to clone it, apply the filter to the clone and then push the the filtered repository to your origin server (if you use one). The following example assumes youâ€™ve created an empty repository ready for the submodule:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code>git clone <span class=nv>$REPO_URL</span> <span class=nv>$SUBMODULE_NAME</span>
<span class=nb>cd</span> <span class=nv>$SUBMODULE_NAME</span>
git filter-branch <span class=nt>--subdirectory-filter</span> <span class=s1>'$PATH_TO_SUBMODULE'</span> <span class=nt>--prune-empty</span> <span class=nt>--</span> <span class=nt>--all</span>

<span class=c># Clean the repository</span>
git clean <span class=nt>-xd</span> <span class=nt>-f</span>

<span class=c># Update the remote (replace "origin" with your remote name)</span>
git remote <span class=nb>rm </span>origin
git remote add origin <span class=nv>$SUBMODULE_REPO_URL</span>

<span class=c># Push the new submodule</span>
git push origin master
</code></pre></div></div><p>All thatâ€™s left to do then is remove the existing directory and add the submodule. Even if youâ€™re paranoid the removed directoryâ€™s history is still in Git, so itâ€™s easy to roll back.</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code>git <span class=nb>rm</span> <span class=nv>$PATH_TO_SUBMODULE</span>
git commit <span class=nt>-m</span> <span class=s2>"Removing directory to replace with submodule"</span> <span class=nv>$PATH_TO_SUBMODULE</span>
git submodule add <span class=nv>$SUBMODULE_REPO_URL</span> <span class=nv>$PATH_TO_SUBMODULE</span>
git add .gitmodules <span class=nv>$PATH_TO_SUBMODULE</span>
git commit <span class=nt>-m</span> <span class=s2>"Adding submodule X"</span>
git push
</code></pre></div></div><p>For the Puppet example the repository resides at /etc/puppet and I used the following variables:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code>SUBMODULE_NAME <span class=o>=</span> puppet-rsnapshot
PATH_TO_SUBMODULE <span class=o>=</span> modules/rsnapshot
</code></pre></div></div><h1 id=references>References</h1><ol><li>http://git-scm.com/book/en/Git-Tools-Submodules</li><li>http://stackoverflow.com/questions/12514197/convert-a-git-folder-to-a-submodule-retrospectively</li></ol><hr><div class=discussion><h1>Discuss!</h1><p>Was this post useful? Why not help others find it by sharing on <a href="https://twitter.com/intent/user?screen_name=spikeheap" target=_blank><i class="fa fa-twitter"></i> twitter</a>. While you're there, get in touch and let me know what you think!</p></div><div class=post-nav><a class="hidden-xs btn btn-sm btn-default pull-left half-width-max text-overflow" href="/posts/2013-08-15-rsnapshot-puppet-module/"><i class="fa fa-arrow-circle-left"></i> Rsnapshot Puppet module</a> <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2013-08-15-rsnapshot-puppet-module/"><i class="fa fa-fw fa-arrow-circle-left"></i> Rsnapshot Puppet module</a> <a class="btn btn-sm btn-default hidden-xs pull-right half-width-max text-overflow" href="/posts/2013-08-18-some-notes-on-backup/">Some notes on backup <i class="fa fa-arrow-circle-right"></i></a> <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2013-08-18-some-notes-on-backup/"><i class="fa fa-fw fa-arrow-circle-right"></i> Some notes on backup</a> <span class=clearfix></span></div></div><div class="col-sm-3 border-left"><div class=bio><img src=/images/profile-400px.d912.jpg><h3>Hi, I'm Ryan</h3><p>I care about code, building great teams and the community. I run <a href=https://www.slatehorse.com>Slate Horse</a> but I'm still a full-stack developer. Previously co-organiser of <a href="http://jsoxford.com/">JSOxford</a> and <a href="http://oxrug.org/">OxRUG</a>.</p><hr><h4>Get in touch</h4><div class=contact-icons><a target=_blank href=https://twitter.com/spikeheap><i class="fa fa-2x fa-twitter-square"></i></a> <a target=_blank href=https://github.com/spikeheap><i class="fa fa-2x fa-github-square"></i></a> <a target=_blank href=http://uk.linkedin.com/in/ryanpbrooks><i class="fa fa-2x fa-linkedin-square"></i></a> <a target=_blank href=mailto:ryanbrooksis+info@gmail.com><i class="fa fa-2x fa-envelope-square"></i></a></div></div></div></div></div><footer class="container-fluid footer--bottom"><div class=container><small>&copy; Ryan Brooks. The content of this page is licensed under the Creative Commons Attribution 3.0 License.</small></div></footer><script src=/vendor/node_modules/jquery/dist/jquery.min.js></script><script src=/vendor/node_modules/bootstrap-sass/assets/javascripts/bootstrap.js></script></body></html>
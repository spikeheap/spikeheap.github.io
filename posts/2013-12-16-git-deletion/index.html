

<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Preparing a Git repository for open-sourcification</title>
        

        
          <!-- facebook open graph tags -->
          <meta property="og:type" content="article" />
          <meta property="og:site_name" content="Ryan Brooks' blog">
          <meta property="og:url" content="https://www.ryanbrooks.co.uk/posts/2013-12-16-git-deletion/" />
          <meta property="og:title" content="Preparing a Git repository for open-sourcification" />
          <meta property="og:description" content="" />

          <!-- twitter card tags additive with the og: tags -->
          <meta name="twitter:card" content="summary">
          <meta name="twitter:site" content="@spikeheap" />
          <meta name="twitter:url" value="https://www.ryanbrooks.co.uk/posts/2013-12-16-git-deletion/" />
          <meta name="twitter:title" value="Preparing a Git repository for open-sourcification" />
          <meta name="twitter:description" value="" />
          <meta name="twitter:label1" value="Reading time" />
          <meta name="twitter:data1" value="🕒 5 minutes" />
        
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="alternate" type="application/rss+xml" title="Ryan Brooks' blog" href="https://www.ryanbrooks.co.uk/feed.xml">
        <!-- build:css /css/style.css -->
        <link rel="stylesheet" href="/css/style.css">
        <!-- endbuild -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-43110335-1');ga('send','pageview');
        </script>
        <meta name="google-site-verification" content="Ie2d0Oy5dhnMbWcw7qg7PIeq3Wiv9X7GoyyL9pz39Eo" />
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <nav class="navbar navbar-default navbar-top">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Ryan Brooks</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        
        
          
            <li><a href="/archives/">Blog archive</a></li>
          
        
      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a class="nav-fa-link target="_blank" href="https://github.com/spikeheap"><i class="fa fa-2x fa-github-square"></i></a></li>
    		<li><a class="nav-fa-link target="_blank" href="https://twitter.com/spikeheap"><i class="fa fa-2x fa-twitter-square"></i></a></li>
    		<li><a class="nav-fa-link target="_blank" href="http://uk.linkedin.com/in/ryanpbrooks"><i class="fa fa-2x fa-linkedin-square"></i></a></li>
    		<li><a class="nav-fa-link target="_blank" href="mailto:ryanbrooksis+info@gmail.com"><i class="fa fa-2x fa-envelope-square"></i></a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div>
</nav>


        <div class="container">
  <div class="row">
      <div class="col-sm-9">
          <h1 class="page-title">Preparing a Git repository for open-sourcification</h1>
          <span class="text-muted">16 Dec 2013</span>, <span class="reading-time text-muted">4 minute read</span>
          <p></p>
          <p>A project I’m involved with is going through the process of being open-sourced and released on GitHub. This is a great development, but of course we have had to go through and make sure that we’re able to release everything. The project started out life in a single Git repository so there’s plenty of bootstrap data that’s owned by other groups within the University. Fortunately there’s an easy way in Git to go through your history and remove the offending articles.</p>

<!-- more -->

<p><strong>Update 18/12/2013</strong> For those who don’t want to re-clone their project, I’ve added the commands to flush the deleted refs from your local repository. I’ve also added a small section on identifying and removing space-hungry sections of the git repository.</p>

<p>There are many ways to achieve the same goal, and we could arguably have retained the same repository, however it’s a nice opportunity to clear out the 300Mb which magically worked its way into the repository at some point and generally streamline our code.</p>

<h5 id="a-word-of-warning">A word of warning</h5>
<p>The following will go through your entire tree and remove all references to the files you’re removing, rewriting commits where necessary. As a result your local repository will likely wildly differ from the remote repository, so you’ll need to coordinate this with your fellow team members. If your repository is already in the wild is there much point in causing this much pain? You can probably just get away with removing it from your tags and branches, which is far less invasive.</p>

<h5 id="a-second-word-of-warning">A second word of warning</h5>
<p>This is a destructive process that rewrites history. <strong>Make sure you’ve got a backup</strong> before attempting this, just in case things go pear-shaped.</p>

<p><strong>Update 18/12/2013</strong> GitHub’s documentation is pretty thorough, so it wasn’t surprising to find <a href="https://help.github.com/articles/remove-sensitive-data">a page on removing sensitive data</a>. I’ve updated this post to reflect some of the suggestions in that page.</p>

<p>The first thing to do is remove the offending content from your repository, and push that change. This is an important step because you want a commit at HEAD which isn’t modified by the following actions, which allows other users to pull the changes without having to nuke their repository.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git <span class="nb">rm  </span>path/to/our/secret/bootstrap-data/
git commit <span class="nt">-m</span> <span class="s2">"Removing bootstrap data"</span> path/to/our/secret/bootstrap-data/
git push
</code></pre></div></div>

<p>Then we can filter the commit history to remove the offending content from the history of all branches:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git filter-branch <span class="nt">--force</span> <span class="nt">--index-filter</span> <span class="s1">'git rm --cached --ignore-unmatch path/to/our/secret/bootstrap-data/'</span> <span class="nt">--prune-empty</span> <span class="nt">--tag-name-filter</span> <span class="nb">cat</span> <span class="nt">--</span> <span class="nt">--all</span>
</code></pre></div></div>

<p>Because you’ve just rewritten history, the <code>git status</code> command will then yield something like</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># On branch develop
# Your branch and 'origin/develop' have diverged,
# and have 373 and 372 different commits each, respectively.
#   (use "git pull" to merge the remote branch into yours)
#
nothing to commit, working directory clean
</code></pre></div></div>

<p>The next thing to do is purge it from the local repository by forcing a garbage collection, like so:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">rm</span> <span class="nt">-rf</span> .git/refs/original/
git reflog expire <span class="nt">--expire</span><span class="o">=</span>now <span class="nt">--all</span>
git gc <span class="nt">--prune</span><span class="o">=</span>now
git gc <span class="nt">--aggressive</span> <span class="nt">--prune</span><span class="o">=</span>now
</code></pre></div></div>

<h2 id="clearing-large-repositories">Clearing large repositories</h2>
<p>In our case, our project was around ~15Mb, however the repository had racked up over 300Mb. The obvious culprit is committed <code>target</code> directories, libraries and built WAR files.</p>

<p>To find out the size of your git repository, use <code>git count-objects -v</code> (you’re looking for the size-pack value, which is the project size in kilobytes).</p>

<p>Ted Naleid has written an excellent article on <a href="http://naleid.com/blog/2012/01/17/finding-and-purging-big-files-from-git-history">finding and purging big files from git history</a>, along with a couple of one-liners to get locate the biggest files.</p>

<p>I’ve dumped the above into a handy little script:</p>

<noscript><pre>FILE_TO_DELETE=&quot;target&quot;

# Filter the history
git filter-branch --force --index-filter &#39;git rm --cached --ignore-unmatch ${FILE_TO_DELETE&#39; --prune-empty --tag-name-filter cat -- --all

# Purge the local repository and force garbage collection
rm -rf .git/refs/original/
git reflog expire --expire=now --all
git gc --prune=now
git gc --aggressive --prune=now

# Print new repository size
git count-objects -v</pre></noscript>
<script src="https://gist.github.com/spikeheap/8019649.js"> </script>

<!-- TODO Overwriting history, or pushing a new repository -->

<h2 id="reapplying-commits">Reapplying commits</h2>
<p>It’s almost certainly the case that someone cloned your repository and made some changes while you were off rewriting history. If you’re now working on a new repository, the easiest way might be to create a patch from the old repo and then apply it to the new one. Using the following command, “-1” refers to the last 1 commit, so you can use “-2”, “-3”, and so on.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Make a patchfile </span>
git format-patch <span class="nt">-1</span>

<span class="c"># Apply the patchfile</span>
patch <span class="nt">-p1</span> &lt; file.patch
</code></pre></div></div>

<p>And voila, you’re back up and running again. Of course there’s plenty more to do: adding a permissive license, attributing any libraries and most importantly building a pretty website for it…</p>

          <hr>

          <div class="discussion">
<h1>Discuss!</h1>
<p>
  Was this post useful? Why not help others find it by sharing on <a href="https://twitter.com/intent/user?screen_name=spikeheap" target="_blank"><i class="fa fa-twitter"></i> twitter</a>. While you're there, get in touch and let me know what you think!
</p>
</div>

          <div class="post-nav">

    <a class="hidden-xs btn btn-sm btn-default pull-left half-width-max text-overflow" href="/posts/2013-12-01-pi-powered-central-heating-phase-1/"><i class="fa fa-arrow-circle-left"></i> Pi-powered central heating phase 1</a>
    <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2013-12-01-pi-powered-central-heating-phase-1/"><i class="fa fa-fw fa-arrow-circle-left"></i> Pi-powered central heating phase 1</a>




    <a class="btn btn-sm btn-default hidden-xs pull-right half-width-max text-overflow" href="/posts/2014-01-23-bower-dependencies-with-gradle/">Bower dependencies with Gradle <i class="fa fa-arrow-circle-right"></i></a>
    <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2014-01-23-bower-dependencies-with-gradle/"><i class="fa fa-fw fa-arrow-circle-right"></i> Bower dependencies with Gradle</a>

<span class="clearfix">
</span>
</div>



      </div>
      <div class="col-sm-3 border-left">
        <div class="bio">
  <img src="/images/profile-400px.jpg">
  <h3>Hi, I'm Ryan</h3>
  <p>
      I care about code, building great teams and the community. I run <a href="https://www.slatehorse.com">Slate Horse</a> but I'm still a full-stack developer. Previously co-organiser of <a href="http://jsoxford.com/">JSOxford</a> and <a href="http://oxrug.org/">OxRUG</a>.
  </p>

  <hr>

  <h4>Get in touch</h4>

  <div class="contact-icons">
	<a target="_blank" href="https://twitter.com/spikeheap"><i class="fa fa-2x fa-twitter-square"></i></a>
  <a target="_blank" href="https://github.com/spikeheap"><i class="fa fa-2x fa-github-square"></i></a>
	<a target="_blank" href="http://uk.linkedin.com/in/ryanpbrooks"><i class="fa fa-2x fa-linkedin-square"></i></a>
	<a target="_blank" href="mailto:ryanbrooksis+info@gmail.com"><i class="fa fa-2x fa-envelope-square"></i></a>
</div>

</div>

      </div>
  </div>
</div>


        <footer class="container-fluid footer--bottom">
	<div class="container">
		<small>
			&copy; Ryan Brooks. The content of this page is licensed under the Creative Commons Attribution 3.0 License.
		</small>
	</div>
</footer>


        <script src="/vendor/node_modules/jquery/dist/jquery.min.js"></script>
        <script src="/vendor/node_modules/bootstrap-sass/assets/javascripts/bootstrap.js"></script>
    </body>
</html>



<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Rsnapshot Puppet module</title>
        

        
          <!-- facebook open graph tags -->
          <meta property="og:type" content="article" />
          <meta property="og:site_name" content="Ryan Brooks' blog">
          <meta property="og:url" content="https://www.ryanbrooks.co.uk/posts/2013-08-15-rsnapshot-puppet-module/" />
          <meta property="og:title" content="Rsnapshot Puppet module" />
          <meta property="og:description" content="" />

          <!-- twitter card tags additive with the og: tags -->
          <meta name="twitter:card" content="summary">
          <meta name="twitter:site" content="@spikeheap" />
          <meta name="twitter:url" value="https://www.ryanbrooks.co.uk/posts/2013-08-15-rsnapshot-puppet-module/" />
          <meta name="twitter:title" value="Rsnapshot Puppet module" />
          <meta name="twitter:description" value="" />
          <meta name="twitter:label1" value="Reading time" />
          <meta name="twitter:data1" value="ðŸ•’ 3 minutes" />
        
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="alternate" type="application/rss+xml" title="Ryan Brooks' blog" href="https://www.ryanbrooks.co.uk/feed.xml">
        <!-- build:css /css/style.css -->
        <link rel="stylesheet" href="/css/style.css">
        <!-- endbuild -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-43110335-1');ga('send','pageview');
        </script>
        <meta name="google-site-verification" content="Ie2d0Oy5dhnMbWcw7qg7PIeq3Wiv9X7GoyyL9pz39Eo" />
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <nav class="navbar navbar-default navbar-top">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Ryan Brooks</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        
        
          
            <li><a href="/archives/">Blog archive</a></li>
          
        
      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a class="nav-fa-link target="_blank" href="https://github.com/spikeheap"><i class="fa fa-2x fa-github-square"></i></a></li>
    		<li><a class="nav-fa-link target="_blank" href="https://twitter.com/spikeheap"><i class="fa fa-2x fa-twitter-square"></i></a></li>
    		<li><a class="nav-fa-link target="_blank" href="http://uk.linkedin.com/in/ryanpbrooks"><i class="fa fa-2x fa-linkedin-square"></i></a></li>
    		<li><a class="nav-fa-link target="_blank" href="mailto:ryanbrooksis+info@gmail.com"><i class="fa fa-2x fa-envelope-square"></i></a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div>
</nav>


        <div class="container">
  <div class="row">
      <div class="col-sm-9">
          <h1 class="page-title">Rsnapshot Puppet module</h1>
          <span class="text-muted">15 Aug 2013</span>, <span class="reading-time text-muted">2 minute read</span>
          <p></p>
          <blockquote>
People want to be seen as being clever, so the result is people wind up working in a cave.
<small>Brian Fitzpatrick, Ben Collins-Sussman <cite>http://www.youtube.com/watch?v=0SARbwvhupQ</cite></small>
</blockquote>

<p>Iâ€™m often a perfectionist, and after watching <a href="http://www.youtube.com/watch?v=0SARbwvhupQ">this excellent talk at Google I/O 2009</a> have realised Iâ€™m definitely guilty of keeping things under wraps until theyâ€™re â€˜readyâ€™ (read â€˜dead and forgottenâ€™). Hereâ€™s my attempt to rectify that.</p>

<p>Over the past couple of weeks Iâ€™ve been building a full-fledged <a href="http://www.rsnapshot.org/">Rsnapshot</a> module for the <a href="http://projects.puppetlabs.com/">Puppet configuration management platform</a>. What started as a simple puppet-isation of an install turned into a labour of love to build my first publishable Puppet module.</p>

<p>The module can be found here: https://github.com/spikeheap/puppet_rsnapshot and is released under the <a href="http://www.gnu.org/licenses/gpl.html">GPL v3</a>. Pull requests and issues are welcome! 
<!-- more -->
The module solves a simple problem: configure a central Rsnapshot system with node-specific backup directories. The module is completely hiera-compatible.</p>

<p>Declaring an Rsnapshot server is as simple as:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">{</span><span class="s1">'backup.example.com'</span><span class="p">:</span>
  <span class="n">rsnapshot</span><span class="p">{</span><span class="s1">'backup'</span><span class="p">:</span>
    <span class="n">sync_first</span>      <span class="o">=&gt;</span> <span class="kp">true</span>
		<span class="n">ssh_private_key</span> <span class="o">=&gt;</span> <span class="no">YOURSSHKEY</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then declare a client as follows:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">{</span><span class="s1">'cleverthing.example.com'</span><span class="p">:</span>
  <span class="n">rsnapshot</span><span class="o">::</span><span class="n">client</span><span class="p">{</span><span class="s1">'cleverthing'</span><span class="p">:</span>
    <span class="n">dirs</span> <span class="o">=&gt;</span> <span class="p">[</span>
		  <span class="s1">'/usr/local/myamazingapp/'</span><span class="p">,</span>
		  <span class="s1">'/var/'</span>
		<span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Itâ€™s even simpler if youâ€™re using Hiera, where youâ€™d declare the server as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">classes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">rsnapshot</span>

<span class="s">rsnapshot::ssh_private_key</span><span class="pi">:</span> <span class="pi">|</span>
  <span class="no">-----BEGIN RSA PRIVATE KEY-----</span>
  <span class="no">...</span>
  <span class="no">-----END RSA PRIVATE KEY-----</span>

<span class="c1"># All the following variables are optional, and are just to illustrate configuration </span>
<span class="s">rsnapshot::sync_first</span><span class="pi">:</span> <span class="no">true</span>
<span class="s">rsnapshot::interval_hourly</span><span class="pi">:</span> <span class="s">24</span>
<span class="s">rsnapshot::cron_sync_hour</span><span class="pi">:</span> <span class="s1">'</span><span class="s">*'</span>
<span class="s">rsnapshot::cron_sync_minute</span><span class="pi">:</span> <span class="s">0</span>
<span class="s">rsnapshot::cron_hourly_hour</span><span class="pi">:</span> <span class="s1">'</span><span class="s">*'</span>
<span class="s">rsnapshot::cron_hourly_minute</span><span class="pi">:</span> <span class="s">30</span>
<span class="s">rsnapshot::cron_daily_hour</span><span class="pi">:</span> <span class="s">23</span>
<span class="s">rsnapshot::cron_daily_minute</span><span class="pi">:</span> <span class="s">0</span>
<span class="s">rsnapshot::cron_weekly_hour</span><span class="pi">:</span> <span class="s">22</span>
<span class="s">rsnapshot::cron_weekly_minute</span><span class="pi">:</span> <span class="s">0</span>
<span class="s">rsnapshot::cron_monthly_hour</span><span class="pi">:</span> <span class="s">21</span>
<span class="s">rsnapshot::cron_monthly_minute</span><span class="pi">:</span> <span class="s">0</span>
<span class="s">rsnapshot::snapshot_root</span><span class="pi">:</span> <span class="s">/backups/rsnapshot/</span>
</code></pre></div></div>

<p>and the client:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">classes</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">rsnapshot::client</span>

<span class="s">rsnapshot::client::dirs</span><span class="pi">:</span> <span class="pi">[</span>
<span class="s1">'</span><span class="s">/usr/local/myamazingapp/'</span><span class="pi">,</span>
<span class="s1">'</span><span class="s">/var/'</span>
<span class="pi">]</span>
</code></pre></div></div>

<p>The module has support for all the configuration options of Rsnapshot, and Iâ€™ll update the documentation shortly to explain the additional parameters.</p>

<h3 id="limitations">Limitations</h3>

<p>Currently the module doesnâ€™t have any tests, so use it at your peril and test it on a staging environment first. This has also been developed entirely on an Ubuntu platform so your mileage may vary on other systems, though thereâ€™s no reason it wonâ€™t work with the right paths passed to it.</p>

<p>I havenâ€™t published the module to the <a href="https://forge.puppetlabs.com/">Puppet Forge</a> yet because I want to complete a suite of tests, check it with puppet-lint and get the documentation up to scratch first.</p>

<p>In addition, the following features arenâ€™t yet complete:</p>

<ul>
  <li>Read-only NFS mount of the backup for recovery</li>
  <li>Node-defined exclusions (Iâ€™m not sure if this is possible with Rsnapshot)</li>
  <li>Read-only rsync server accessed over SSH. A best-practice setup using restricted SSH access to a read-only rsync daemon to reduce the possibilty of attack through the backup system.</li>
  <li>Report collection</li>
  <li>Per-host pre-backup scripts</li>
  <li>Space checking prior to backup</li>
</ul>

<p>This is my first foray into Puppet modules, so feedback and (gentle) criticism is invited so I can learn. That link again is https://github.com/spikeheap/puppet_rsnapshot .</p>

          <hr>

          <div class="discussion">
<h1>Discuss!</h1>
<p>
  Was this post useful? Why not help others find it by sharing on <a href="https://twitter.com/intent/user?screen_name=spikeheap" target="_blank"><i class="fa fa-twitter"></i> twitter</a>. While you're there, get in touch and let me know what you think!
</p>
</div>

          <div class="post-nav">

    <a class="hidden-xs btn btn-sm btn-default pull-left half-width-max text-overflow" href="/posts/2013-08-13-managing-sudoers-with-puppet/"><i class="fa fa-arrow-circle-left"></i> Managing sudoers with Puppet</a>
    <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2013-08-13-managing-sudoers-with-puppet/"><i class="fa fa-fw fa-arrow-circle-left"></i> Managing sudoers with Puppet</a>




    <a class="btn btn-sm btn-default hidden-xs pull-right half-width-max text-overflow" href="/posts/2013-08-16-refactoring-directory-into-git-submodule/">Refactoring a directory into a git submodule <i class="fa fa-arrow-circle-right"></i></a>
    <a class="visible-xs-block btn btn-default btn-block text-overflow" href="/posts/2013-08-16-refactoring-directory-into-git-submodule/"><i class="fa fa-fw fa-arrow-circle-right"></i> Refactoring a directory into a git submodule</a>

<span class="clearfix">
</span>
</div>



      </div>
      <div class="col-sm-3 border-left">
        <div class="bio">
  <img src="/images/profile-400px.jpg">
  <h3>Hi, I'm Ryan</h3>
  <p>
      I care about code, building great teams and the community. I run <a href="https://www.slatehorse.com">Slate Horse</a> but I'm still a full-stack developer. Previously co-organiser of <a href="http://jsoxford.com/">JSOxford</a> and <a href="http://oxrug.org/">OxRUG</a>.
  </p>

  <hr>

  <h4>Get in touch</h4>

  <div class="contact-icons">
	<a target="_blank" href="https://twitter.com/spikeheap"><i class="fa fa-2x fa-twitter-square"></i></a>
  <a target="_blank" href="https://github.com/spikeheap"><i class="fa fa-2x fa-github-square"></i></a>
	<a target="_blank" href="http://uk.linkedin.com/in/ryanpbrooks"><i class="fa fa-2x fa-linkedin-square"></i></a>
	<a target="_blank" href="mailto:ryanbrooksis+info@gmail.com"><i class="fa fa-2x fa-envelope-square"></i></a>
</div>

</div>

      </div>
  </div>
</div>


        <footer class="container-fluid footer--bottom">
	<div class="container">
		<small>
			&copy; Ryan Brooks. The content of this page is licensed under the Creative Commons Attribution 3.0 License.
		</small>
	</div>
</footer>


        <script src="/vendor/node_modules/jquery/dist/jquery.min.js"></script>
        <script src="/vendor/node_modules/bootstrap-sass/assets/javascripts/bootstrap.js"></script>
    </body>
</html>
